<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reports & Ledgers</title>
  <link rel="icon" type="image/png" href="https://www.pristinepearlpharma.in/images/alt-logo.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- SheetJS for Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- Chart.js for all charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    body { font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial; }
    .sidebar-wrapper {
      transition: transform 0.3s ease-in-out;
    }
    .tab-active { background:#10b981; color:#fff; font-weight: 600; }
    .no-print { display: block; }
    /* Ensure the chart container is stable */
    .chart-container {
        position: relative;
        height: 320px; /* Fixed height for consistency */
    }

    @media (max-width: 768px) {
      .sidebar-wrapper {
        position: fixed;
        z-index: 40;
        top: 0;
        left: 0;
        height: 100vh;
        overflow-y: auto;
        padding-top: 5rem;
        transform: translateX(-100%);
        box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      }
      .sidebar-wrapper.open {
        transform: translateX(0);
      }
      .sidebar-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        z-index: 35;
      }
    }
    .table-header-bg { background-color: #f7fafc; }
    @media print { .no-print { display: none } }
  </style>
</head>
<body class="bg-gray-100 text-slate-800">

<script>
/* IMPORTANT: The WEB_APP_URL is assumed to be defined by the user in the environment */
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwvsPLvAggLwxA5v2qrP12pYxhDsg5cG2zielynHmGDStg8TRyyi9oYGVnS-9_mbD4q/exec";
</script>

<!-- Header -->
<header class="bg-white border-b px-4 py-3 sticky top-0 z-40 no-print shadow-md">
  <div class="max-w-7xl mx-auto flex items-center justify-between">
    <div class="flex items-center gap-3">
 <img src="https://pristinepearl.com/wp-content/uploads/2020/11/Pristine-Pearl-Pharma-Logo-1.svg" alt="Pristine Pearl Pharma Logo" class="w-20 h-20 object-contain rounded-lg" onerror="this.onerror=null;this.src='https://placehold.co/40x40/059669/ffffff?text=PP'">
      <div>
        <div class="text-xl font-bold">Inventory Reports</div>
        <div class="text-xs text-slate-500">Pristine Pearl Pharma</div>
      </div>
    </div>

    <div class="flex items-center gap-2">
      <button id="menuToggle" class="md:hidden p-2 rounded-lg border bg-gray-100 hover:bg-gray-200 transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
      <button id="refreshBtn" class="px-3 py-2 rounded-lg border bg-white hover:bg-gray-50 transition-colors text-sm">Refresh</button>
      <button id="goBtn" class="px-3 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 transition-colors text-sm">Go</button>
      <button id="exportExcelBtn" class="px-3 py-2 rounded-lg border bg-white hover:bg-gray-50 transition-colors text-sm">Export Excel</button>
      <button id="exportCsvBtn" class="px-3 py-2 rounded-lg border bg-white hover:bg-gray-50 transition-colors text-sm">Export CSV</button>
      <a href="index.html" class="px-3 py-2 rounded-lg border bg-slate-100 hover:bg-slate-200 transition-colors text-sm">Back</a>
    </div>
  </div>
</header>

<!-- Sidebar Backdrop (for mobile) -->
<div id="sidebarBackdrop" class="sidebar-backdrop hidden md:hidden" onclick="toggleSidebar()"></div>

<main class="max-w-7xl mx-auto p-4 md:p-6 grid grid-cols-1 md:grid-cols-4 gap-6">
  <!-- Sidebar (full text) -->
  <aside id="sidebar"
  class="col-span-1 bg-white border rounded-xl p-4 shadow-lg sidebar-wrapper
         md:sticky md:top-20 md:h-[calc(100vh-80px)] md:flex md:flex-col">
    <div class="text-lg font-bold text-slate-700 mb-4">Reports & Ledgers</div>
    <div class="flex flex-col gap-2">
<button class="sidebtn px-3 py-2 rounded-lg text-left tab-active hover:bg-gray-50 transition-colors"
        data-target="dashboard"
        onclick="switchTab(event)">
  Home
</button>
      <button class="sidebtn px-3 py-2 rounded-lg text-left hover:bg-gray-50"
        data-target="stock" onclick="switchTab(event)">Stock Summary</button>
      <button class="sidebtn px-3 py-2 rounded-lg text-left hover:bg-gray-50 transition-colors" data-target="minStock" onclick="switchTab(event)">Minimum Stock</button>
      <button class="sidebtn px-3 py-2 rounded-lg text-left hover:bg-gray-50 transition-colors" data-target="expiry" onclick="switchTab(event)">Expiry Tracker</button>
      <button class="sidebtn px-3 py-2 rounded-lg text-left hover:bg-gray-50 transition-colors" data-target="receipts" onclick="switchTab(event)">Receipts Summary</button>
      <button class="sidebtn px-3 py-2 rounded-lg text-left hover:bg-gray-50 transition-colors" data-target="teamSupply" onclick="switchTab(event)">Team Supply Report</button>
      <button class="sidebtn px-3 py-2 rounded-lg text-left hover:bg-gray-50 transition-colors" data-target="productLedger" onclick="switchTab(event)">Product Ledger</button>
      <button class="sidebtn px-3 py-2 rounded-lg text-left hover:bg-gray-50 transition-colors" data-target="employeeLedger" onclick="switchTab(event)">Employee Ledger</button>
    </div>
<button class="sidebtn px-3 py-2 rounded-lg text-left hover:bg-gray-50 transition-colors"
        data-target="employeeDistribution"
        onclick="switchTab(event)">
  Distribution - Staffwise
</button>
<button class="sidebtn px-3 py-2 rounded-lg text-left hover:bg-gray-50 transition-colors"
        data-target="productDistribution"
        onclick="switchTab(event)">
  Distribution - Productwise
</button>

    <hr class="my-4 border-gray-200" />

<div class="flex-1 overflow-hidden flex flex-col">
  
  <div class="text-sm font-semibold text-slate-600 mb-3">
    Filters
  </div>

  <div class="mt-2 space-y-3 text-sm overflow-y-auto pr-2">
      <div>
        <label class="block text-xs font-medium text-slate-500">Product Type</label>
        <select id="filterType" class="w-full border border-gray-300 rounded-lg px-3 py-2 mt-1 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"></select>
      </div>
      <div>
        <label class="block text-xs font-medium text-slate-500">Date From</label>
        <input id="filterFrom" type="date" class="w-full border border-gray-300 rounded-lg px-3 py-2 mt-1 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500" />
      </div>
      <div>
        <label class="block text-xs font-medium text-slate-500">Date To</label>
        <input id="filterTo" type="date" class="w-full border border-gray-300 rounded-lg px-3 py-2 mt-1 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500" />
      </div>
      <div>
        <label class="block text-xs font-medium text-slate-500">Search</label>
        <input id="filterSearch" placeholder="Product, batch, employee..." class="w-full border border-gray-300 rounded-lg px-3 py-2 mt-1 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500" />
      </div>
    </div>
  </aside>

  <!-- Content -->
  <section class="col-span-3 space-y-6">
    <!-- Active label -->
    <div class="bg-white p-4 rounded-xl border shadow-sm">
      <div class="flex items-center justify-between">
        <div class="text-base text-slate-600 font-medium">Active Report: <strong id="activeLabel" class="text-indigo-600">Home</strong></div>
        <div class="text-xs text-slate-500">Click the <strong class="text-indigo-600">Go</strong> button to apply filters.</div>
      </div>
    </div>

    <!-- Panels -->
    <div id="panels" class="space-y-6">

<!-- DASHBOARD -->
<div id="dashboard" class="panel bg-white p-4 rounded-xl border shadow-lg">

  <div class="mb-6">
    <h3 class="text-2xl font-bold text-slate-700">Inventory Dashboard</h3>
    <div class="text-sm text-slate-500">Complete inventory overview.</div>
  </div>

  <!-- SUMMARY CARDS -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">

    <div class="bg-indigo-50 p-4 rounded-xl border">
      <div class="text-xs">Total Products</div>
      <div id="dbTotalProducts" class="text-xl font-bold">0</div>
    </div>

    <div class="bg-emerald-50 p-4 rounded-xl border">
      <div class="text-xs">Total Inventory Value</div>
      <div id="dbTotalValue" class="text-xl font-bold">â‚¹0</div>
    </div>

    <div class="bg-red-50 p-4 rounded-xl border">
      <div class="text-xs">Total Expired Qty / Value</div>
      <div id="dbExpired" class="text-xl font-bold">0 / â‚¹0</div>
    </div>

    <div class="bg-amber-50 p-4 rounded-xl border">
      <div class="text-xs">Total Short Expiry Qty / Value</div>
      <div id="dbShortExpiry" class="text-xl font-bold">0 / â‚¹0</div>
    </div>

    <div class="bg-blue-50 p-4 rounded-xl border">
      <div class="text-xs">Total Receipts</div>
      <div id="dbReceipts" class="text-xl font-bold">0</div>
    </div>

    <div class="bg-purple-50 p-4 rounded-xl border">
      <div class="text-xs">Total Supplies</div>
      <div id="dbSupplies" class="text-xl font-bold">0</div>
    </div>

  </div>

  <!-- CHARTS -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

    <div class="bg-white p-4 rounded-xl border shadow-sm">
      <h4 class="font-semibold mb-3">Product Chart</h4>
      <div class="chart-container">
        <canvas id="dbProductChart"></canvas>
      </div>
    </div>

    <div class="bg-white p-4 rounded-xl border shadow-sm">
      <h4 class="font-semibold mb-3">Product Type Chart</h4>
      <div class="chart-container">
        <canvas id="dbTypeChart"></canvas>
      </div>
    </div>

    <div class="bg-white p-4 rounded-xl border shadow-sm">
      <h4 class="font-semibold mb-3">Team Supply Value Distribution</h4>
      <div class="chart-container">
        <canvas id="dbTeamChart"></canvas>
      </div>
    </div>

    <div class="bg-white p-4 rounded-xl border shadow-sm">
      <h4 class="font-semibold mb-3">Product Distribution</h4>
      <div class="chart-container">
        <canvas id="dbDistributionChart"></canvas>
      </div>
    </div>

  </div>

<!-- TOP 10 DISTRIBUTION TABLES -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">

  <!-- Top 10 Employees -->
  <div class="bg-white p-4 rounded-xl border shadow-sm">
    <h4 class="text-lg font-semibold mb-3 text-slate-700">
      Top 10 Employees - Distribution Value
    </h4>
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-gray-50 border-b">
          <tr>
            <th class="p-3 text-left">Employee</th>
            <th class="p-3 text-right">Total Value (â‚¹)</th>
          </tr>
        </thead>
        <tbody id="dbTopEmployees" class="divide-y divide-gray-100"></tbody>
      </table>
    </div>
  </div>

  <!-- Top 10 Products -->
  <div class="bg-white p-4 rounded-xl border shadow-sm">
    <h4 class="text-lg font-semibold mb-3 text-slate-700">
      Top 10 Products - Distribution Value
    </h4>
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-gray-50 border-b">
          <tr>
            <th class="p-3 text-left">Product</th>
            <th class="p-3 text-right">Total Value (â‚¹)</th>
          </tr>
        </thead>
        <tbody id="dbTopProducts" class="divide-y divide-gray-100"></tbody>
      </table>
    </div>
  </div>

</div>

</div>

      <!-- STOCK -->
      <div id="stock" class="panel bg-white p-4 rounded-xl border shadow-lg hidden">
        <div class="flex justify-between items-center mb-6">
          <div>
            <h3 class="text-2xl font-bold text-slate-700">Stock Summary</h3>
            <div class="text-sm text-slate-500">Current inventory snapshot with key metrics.</div>
          </div>
          <div class="text-sm text-slate-500">Total Batches: <span id="stockCount" class="font-bold text-slate-700">0</span></div>
        </div>

        <!-- NEW Summary Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
          <div class="bg-emerald-50 p-4 rounded-xl border border-emerald-200 shadow-sm">
            <div class="text-xs font-medium text-emerald-700">Total Inventory Value</div>
            <div id="totalStockValue" class="text-2xl font-extrabold mt-1 text-emerald-800">N/A</div>
          </div>
          <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-200 shadow-sm">
            <div class="text-xs font-medium text-indigo-700">Unique Products</div>
            <div id="uniqueProductsCount" class="text-2xl font-extrabold mt-1 text-indigo-800">N/A</div>
          </div>
          <div class="bg-amber-50 p-4 rounded-xl border border-amber-200 shadow-sm">
            <div class="text-xs font-medium text-amber-700">Batches Below Min</div>
            <div id="minStockBatches" class="text-2xl font-extrabold mt-1 text-amber-800">N/A</div>
          </div>
        </div>

        <!-- Product-wise Consolidated Chart -->
<div class="bg-white p-4 rounded-xl border shadow-sm mb-6">
  <div class="flex justify-between items-center mb-3">
    <h4 class="text-lg font-semibold text-slate-700">
      Product Chart
    </h4>

    <div class="flex gap-2 text-xs">
      <button id="toggleValue"
        class="px-3 py-1 rounded bg-indigo-600 text-white">
        Value
      </button>
      <button id="toggleQty"
        class="px-3 py-1 rounded border">
        Qty
      </button>
    </div>
  </div>

  <div class="chart-container">
    <canvas id="productConsolidatedChart"></canvas>
  </div>
</div>

        <!-- Table (Existing, slightly styled) -->
        <h4 class="text-lg font-semibold mb-3 text-slate-700">Detailed Inventory Snapshot</h4>
        <div class="overflow-x-auto rounded-lg border shadow-md">
          <table id="stockTable" class="min-w-full text-sm">
            <thead class="bg-gray-50 border-b"><tr>
              <th class="p-3 text-left font-semibold text-gray-600">Type</th><th class="p-3 text-left font-semibold text-gray-600">Product</th><th class="p-3 text-left font-semibold text-gray-600">Batch</th><th class="p-3 text-left font-semibold text-gray-600">Expiry</th><th class="p-3 text-right font-semibold text-gray-600">Qty</th><th class="p-3 text-right font-semibold text-gray-600">MRP (â‚¹)</th><th class="p-3 text-right font-semibold text-gray-600">Value (â‚¹)</th><th class="p-3 text-left font-semibold text-gray-600">Last Updated</th>
            </tr></thead>
            <tbody class="divide-y divide-gray-100"></tbody>
          </table>
        </div>
      </div>

      <!-- MIN STOCK -->
      <div id="minStock" class="panel bg-white p-4 rounded-xl border shadow-lg hidden">
        <div class="flex justify-between items-center mb-6">
          <div><h3 class="text-2xl font-bold text-slate-700">Minimum Stock</h3><div class="text-sm text-slate-500">Batches below the specified reorder threshold.</div></div>
          <div>
            <label class="text-sm text-slate-600 font-medium mr-2">Threshold Qty:</label>
            <input id="minThreshold" type="number" value="20" class="w-20 border px-3 py-1 rounded-lg focus:border-indigo-500" onchange="renderMinStock()"/>
          </div>
        </div>
        
       

          <!-- Table Container -->
          <div class="lg:col-span-1 bg-white p-4 rounded-xl border shadow-sm">
            <h4 class="text-lg font-semibold mb-3 text-slate-700">Detailed Low Stock List</h4>
            <div class="overflow-x-auto rounded-lg border shadow-md">
              <table id="minTable" class="min-w-full text-sm">
                <thead class="bg-red-50 border-b"><tr>
                  <th class="p-3 text-left font-semibold text-gray-600">Product</th><th class="p-3 text-left font-semibold text-gray-600">Batch</th><th class="p-3 text-left font-semibold text-gray-600">Expiry</th><th class="p-3 text-right font-semibold text-gray-600">Qty</th><th class="p-3 text-right font-semibold text-gray-600">MRP (â‚¹)</th><th class="p-3 text-right font-semibold text-gray-600">Value (â‚¹)</th><th class="p-3 text-left font-semibold text-gray-600">Type</th></tr></thead>
                <tbody class="divide-y divide-gray-100"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- EXPIRY -->
      <div id="expiry" class="panel bg-white p-4 rounded-xl border shadow-lg hidden">
        <div class="flex justify-between items-center mb-6">
          <div><h3 class="text-2xl font-bold text-slate-700">Expiry Tracker</h3><div class="text-sm text-slate-500">Qty & Value of Expired / Short Expiry Stock.</div></div>
          
        </div>

        

          <!-- Table Container -->
          <div class="lg:col-span-1 bg-white p-4 rounded-xl border shadow-sm">
            <h4 class="text-lg font-semibold mb-3 text-slate-700">Detailed Expiry List</h4>
            <div class="overflow-x-auto rounded-lg border shadow-md">
              <table id="expiryTable" class="min-w-full text-sm">
                <thead class="bg-amber-50 border-b"><tr>
                  <th class="p-3 text-left font-semibold text-gray-600">Product</th>
<th class="p-3 text-left font-semibold text-gray-600">Expired</th>
<th class="p-3 text-left font-semibold text-gray-600">Short Expiry</th>
<th class="p-3 text-right font-semibold text-gray-600">MRP</th>
<th class="p-3 text-right font-semibold text-gray-600">Total Value</th></tr></thead>
                <tbody class="divide-y divide-gray-100"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- RECEIPTS -->
      <div id="receipts" class="panel bg-white p-4 rounded-xl border shadow-lg hidden">
        <div class="mb-6"><h3 class="text-2xl font-bold text-slate-700">Receipts Summary</h3>
<!-- Receipts Summary Cards -->
<div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
  <div class="bg-indigo-50 p-4 rounded-xl border">
    <div class="text-xs">Total Receipts Count</div>
    <div id="rsCount" class="text-xl font-bold">0</div>
  </div>
  <div class="bg-emerald-50 p-4 rounded-xl border">
    <div class="text-xs">Total Quantity Received</div>
    <div id="rsQty" class="text-xl font-bold">0</div>
  </div>
  <div class="bg-purple-50 p-4 rounded-xl border">
    <div class="text-xs">Total Receipt Value</div>
    <div id="rsValue" class="text-xl font-bold">â‚¹0</div>
  </div>
</div>
<div class="text-sm text-slate-500">All received inventory items.</div></div>
        <div class="overflow-x-auto rounded-lg border shadow-md">
          <table id="receiptsTable" class="min-w-full text-sm">
            <thead class="table-header-bg border-b"><tr>
              <th class="p-3 text-left font-semibold text-gray-600">Date</th><th class="p-3 text-left font-semibold text-gray-600">Receipt ID</th><th class="p-3 text-left font-semibold text-gray-600">Product</th><th class="p-3 text-left font-semibold text-gray-600">Batch</th><th class="p-3 text-left font-semibold text-gray-600">Expiry</th><th class="p-3 text-right font-semibold text-gray-600">Qty</th><th class="p-3 text-left font-semibold text-gray-600">Supplier</th><th class="p-3 text-right font-semibold text-gray-600">Amount (â‚¹)</th></tr></thead>
            <tbody class="divide-y divide-gray-100"></tbody>
          </table>
        </div>
      </div>

      <!-- TEAM SUPPLY (Original, adapted for new style) -->
      <div id="teamSupply" class="panel bg-white p-4 rounded-xl border shadow-lg hidden">
        <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-6 gap-3">
          <div>
            <h3 class="text-2xl font-bold text-slate-700">Team Supply Report</h3>
            <div class="text-sm text-slate-500">Summary of inventory supplied by team.</div>
          </div>
          <div class="flex flex-wrap items-center gap-3 text-sm">
            <label class="font-medium">Team</label>
            <select id="filterTeam" class="border rounded-lg px-2 py-1"></select>
            <label class="font-medium">From</label>
            <input id="teamFrom" type="date" class="border rounded-lg px-2 py-1" />
            <label class="font-medium">To</label>
            <input id="teamTo" type="date" class="border rounded-lg px-2 py-1" />
            <button id="refreshTeam" class="px-3 py-2 rounded-lg border bg-slate-100 hover:bg-slate-200 transition-colors text-sm">Refresh Team Data</button>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
          <div class="lg:col-span-2 bg-white p-4 rounded-xl border shadow-sm">
            <h4 class="text-lg font-semibold mb-3 text-slate-700">Team Supply Value Summary</h4>
            <div class="overflow-x-auto rounded-lg border shadow-md">
              <table id="teamSummaryTable" class="min-w-full text-sm">
                <thead class="table-header-bg border-b"><tr><th class="p-3 text-left font-semibold text-gray-600">Team</th><th class="p-3 text-right font-semibold text-gray-600">No. of Distributions</th><th class="p-3 text-right font-semibold text-gray-600">Total Value (â‚¹)</th></tr></thead>
                <tbody class="divide-y divide-gray-100"></tbody>
              </table>
            </div>
          </div>
          <div class="lg:col-span-1 bg-white p-4 rounded-xl border shadow-sm flex flex-col justify-center items-center">
            <h4 class="text-lg font-semibold mb-3 text-slate-700">Value Distribution</h4>
            <div class="chart-container w-full h-[300px]">
              <canvas id="teamPie" class="w-full"></canvas>
            </div>
          </div>
        </div>

        <h4 class="text-lg font-semibold mb-3 text-slate-700">Detailed Supply Transactions</h4>
        <div class="overflow-x-auto rounded-lg border shadow-md">
          <table id="teamSupplyTable" class="min-w-full text-sm">
            <thead class="table-header-bg border-b"><tr><th class="p-3 text-left font-semibold text-gray-600">Date</th><th class="p-3 text-left font-semibold text-gray-600">Team</th><th class="p-3 text-left font-semibold text-gray-600">Emp Code</th><th class="p-3 text-left font-semibold text-gray-600">Emp Name</th><th class="p-3 text-left font-semibold text-gray-600">Designation</th><th class="p-3 text-left font-semibold text-gray-600">Product</th><th class="p-3 text-left font-semibold text-gray-600">Batch</th><th class="p-3 text-left font-semibold text-gray-600">Expiry</th><th class="p-3 text-right font-semibold text-gray-600">Qty</th><th class="p-3 text-right font-semibold text-gray-600">Total Value (â‚¹)</th><th class="p-3 text-left font-semibold text-gray-600">Remarks</th></tr></thead>
            <tbody class="divide-y divide-gray-100"></tbody>
          </table>
        </div>
      </div>

      <!-- PRODUCT LEDGER -->
      <div id="productLedger" class="panel bg-white p-4 rounded-xl border shadow-lg hidden">
<!-- Product Ledger Summary Cards -->
<div class="grid grid-cols-1 sm:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
  <div class="bg-indigo-50 p-4 rounded-xl border">
    <div class="text-xs">Total Products</div>
    <div id="plProducts" class="text-xl font-bold">0</div>
  </div>
  <div class="bg-blue-50 p-4 rounded-xl border">
    <div class="text-xs">Total Batches</div>
    <div id="plBatches" class="text-xl font-bold">0</div>
  </div>
  <div class="bg-emerald-50 p-4 rounded-xl border">
    <div class="text-xs">Total Received</div>
    <div id="plReceived" class="text-xl font-bold">0</div>
  </div>
  <div class="bg-red-50 p-4 rounded-xl border">
    <div class="text-xs">Total Supplied</div>
    <div id="plSupplied" class="text-xl font-bold">0</div>
  </div>
  <div class="bg-amber-50 p-4 rounded-xl border">
    <div class="text-xs">Total Remaining</div>
    <div id="plRemaining" class="text-xl font-bold">0</div>
  </div>
  <div class="bg-purple-50 p-4 rounded-xl border">
    <div class="text-xs">Current Stock Value</div>
    <div id="plValue" class="text-xl font-bold">â‚¹0</div>
  </div>
</div>
        <div class="flex justify-between items-center mb-6">
          <div><h3 class="text-2xl font-bold text-slate-700">Product Ledger (Batch-wise)</h3>
<div class="text-sm text-slate-500">View detailed in/out summary for a specific product.</div></div>
          <div><label class="text-sm font-medium mr-2">Product</label><select id="ledgerProduct" class="border rounded-lg px-3 py-1 min-w-[260px] focus:border-indigo-500" onchange="renderProductLedger()"></select></div>
        </div>
        <div class="overflow-x-auto rounded-lg border shadow-md">
          <table id="prodLedgerTable" class="min-w-full text-sm">
            <thead class="table-header-bg border-b"><tr>
              <th class="p-3 text-left font-semibold text-gray-600">Product</th><th class="p-3 text-left font-semibold text-gray-600">Batch</th><th class="p-3 text-left font-semibold text-gray-600">Expiry</th><th class="p-3 text-right font-semibold text-gray-600">Received</th><th class="p-3 text-right font-semibold text-gray-600">Supplied</th><th class="p-3 text-right font-semibold text-gray-600">Remaining</th><th class="p-3 text-right font-semibold text-gray-600">Total Value (â‚¹)</th>
            </tr></thead>
            <tbody class="divide-y divide-gray-100"></tbody>
          </table>
        </div>
      </div>

      <!-- EMPLOYEE LEDGER -->
      <div id="employeeLedger" class="panel bg-white p-4 rounded-xl border shadow-lg hidden">
<!-- Employee Ledger Summary Cards -->
<div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
  <div class="bg-indigo-50 p-4 rounded-xl border">
    <div class="text-xs">Total Transactions</div>
    <div id="elTrans" class="text-xl font-bold">0</div>
  </div>
  <div class="bg-emerald-50 p-4 rounded-xl border">
    <div class="text-xs">Total Quantity Supplied</div>
    <div id="elQty" class="text-xl font-bold">0</div>
  </div>
  <div class="bg-purple-50 p-4 rounded-xl border">
    <div class="text-xs">Total Supply Value</div>
    <div id="elValue" class="text-xl font-bold">â‚¹0</div>
  </div>
</div>

        <div class="flex justify-between items-center mb-6">
          <div><h3 class="text-2xl font-bold text-slate-700">Employee Ledger</h3><div class="text-sm text-slate-500">View all supplies distributed to a specific employee.</div></div>
          <div><label class="text-sm font-medium mr-2">Employee</label><select id="ledgerEmployee" class="border rounded-lg px-3 py-1 min-w-[260px] focus:border-indigo-500" onchange="renderEmployeeLedger()"></select></div>
        </div>
        <div class="overflow-x-auto rounded-lg border shadow-md">
          <table id="empLedgerTable" class="min-w-full text-sm">
            <thead class="table-header-bg border-b"><tr>
              <th class="p-3 text-left font-semibold text-gray-600">Date</th><th class="p-3 text-left font-semibold text-gray-600">Emp Code</th><th class="p-3 text-left font-semibold text-gray-600">Emp Name</th><th class="p-3 text-left font-semibold text-gray-600">Designation</th><th class="p-3 text-left font-semibold text-gray-600">Product</th><th class="p-3 text-left font-semibold text-gray-600">Batch</th><th class="p-3 text-left font-semibold text-gray-600">Expiry</th><th class="p-3 text-right font-semibold text-gray-600">Qty</th><th class="p-3 text-right font-semibold text-gray-600">Total Value (â‚¹)</th><th class="p-3 text-left font-semibold text-gray-600">Remarks</th>
            </tr></thead>
            <tbody class="divide-y divide-gray-100"></tbody>
          </table>
        </div>
      </div>
    </div>

<!-- EMPLOYEE DISTRIBUTION -->
<div id="employeeDistribution" class="panel bg-white p-4 rounded-xl border shadow-lg hidden">
<!-- Staffwise Summary Cards -->
<div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
  <div class="bg-indigo-50 p-4 rounded-xl border">
    <div class="text-xs">Total Employees</div>
    <div id="edTotalEmp" class="text-xl font-bold">0</div>
  </div>
  <div class="bg-emerald-50 p-4 rounded-xl border">
    <div class="text-xs">Total Qty Distributed</div>
    <div id="edTotalQty" class="text-xl font-bold">0</div>
  </div>
  <div class="bg-purple-50 p-4 rounded-xl border">
    <div class="text-xs">Total Distribution Value</div>
    <div id="edTotalValue" class="text-xl font-bold">â‚¹0</div>
  </div>
</div>
  <div class="mb-6">
    <h3 class="text-2xl font-bold text-slate-700">Employee Distribution</h3>
    <div class="text-sm text-slate-500">Consolidated staff-wise supply summary.</div>
  </div>

  <div class="overflow-x-auto rounded-lg border shadow-md mb-6">
    <table id="empDistSummaryTable" class="min-w-full text-sm">
      <thead class="table-header-bg border-b">
        <tr>
  <th class="p-3 text-left">Emp Code</th>
  <th class="p-3 text-left">Emp Name</th>
  <th class="p-3 text-right">Total Distribution</th>
  <th class="p-3 text-right">Total Qty</th>
  <th class="p-3 text-right">Total Value (â‚¹)</th>
</tr>
      </thead>
      <tbody class="divide-y divide-gray-100"></tbody>
    </table>
  </div>
</div>
</div>
<!-- PRODUCT DISTRIBUTION -->
<div id="productDistribution" class="panel bg-white p-4 rounded-xl border shadow-lg hidden">
<!-- Productwise Summary Cards -->
<div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
  <div class="bg-indigo-50 p-4 rounded-xl border">
    <div class="text-xs">Total Products</div>
    <div id="pdTotalProducts" class="text-xl font-bold">0</div>
  </div>
  <div class="bg-emerald-50 p-4 rounded-xl border">
    <div class="text-xs">Total Qty Distributed</div>
    <div id="pdTotalQty" class="text-xl font-bold">0</div>
  </div>
  <div class="bg-purple-50 p-4 rounded-xl border">
    <div class="text-xs">Total Distribution Value</div>
    <div id="pdTotalValue" class="text-xl font-bold">â‚¹0</div>
  </div>
</div>

  <div class="mb-6">
    <h3 class="text-2xl font-bold text-slate-700">Product Distribution</h3>
    <div class="text-sm text-slate-500">Consolidated product-wise supply summary.</div>
  </div>

  <div class="overflow-x-auto rounded-lg border shadow-md">
    <table id="prodDistSummaryTable" class="min-w-full text-sm">
      <thead class="table-header-bg border-b">
        <tr>
          <th class="p-3 text-left">Product Name</th>
          <th class="p-3 text-right">Total Distribution</th>
          <th class="p-3 text-right">Total Qty</th>
          <th class="p-3 text-right">Total Value (â‚¹)</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-100"></tbody>
    </table>
  </div>
</div>

  </section>
</main>

<div id="loading" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/20"><div class="w-16 h-16 rounded-full border-8 border-white/25 border-t-white animate-spin"></div></div>

<script>
/* ---------- Config & State ---------- */
const API = WEB_APP_URL;

let inventory = [], products = [], staff = [], receipts = [], supplies = [], teams = [];
let currentTab = 'dashboard';
let chartInstances = {}; // Global map to store Chart.js instances

/* ---------- Helpers ---------- */
function showLoading(){ document.getElementById('loading').style.display = 'flex'; }
function hideLoading(){ document.getElementById('loading').style.display = 'none'; }

async function post(action, payload = {}) {
  showLoading();
  try {
    const res = await fetch(API, {
      method: 'POST',
      headers: {'Content-Type':'text/plain;charset=utf-8'},
      body: JSON.stringify(Object.assign({action}, payload))
    });
    const json = await res.json();
    hideLoading();
    return json;
  } catch (e) {
    hideLoading();
    console.error(e);
    // Use an error message box instead of alert()
    alert('API error â€” check console and WEB_APP_URL'); 
    return { success:false, message: String(e) };
  }
}

function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
function num(v){ return Number(v)||0; }
function formatIndianNumber(value, withCurrency = false) {
  const n = Number(value) || 0;

  const formatted = n.toLocaleString('en-IN', {
    maximumFractionDigits: 2,
    minimumFractionDigits: 0
  });

  return withCurrency ? 'â‚¹' + formatted : formatted;
}
function getFilteredData(data, dateField = 'Date') {
  const type = document.getElementById('filterType').value;
  const from = document.getElementById('filterFrom').value;
  const to = document.getElementById('filterTo').value;
  const search = (document.getElementById('filterSearch').value || '').toLowerCase();

  return data.filter(r => {

    // Product Type filter
    if (type && r.Type !== type) return false;

    // Date filter
    if (from || to) {
      const rawDate = r[dateField] || r['Receipt Date'] || r['Supply Date'] || r['Last Updated'];
      const d = new Date(rawDate);
      if (from && new Date(from) > d) return false;
      if (to && new Date(to) < d) return false;
    }

    // Search filter
    if (search) {
      const rowText = JSON.stringify(r).toLowerCase();
      if (!rowText.includes(search)) return false;
    }

    return true;
  });
}

/* Date/expiry format utility */
function fmtDDMMYYYY(d){
  if(!d) return '';
  const s = String(d).trim();
  if(/^\d{2}-\d{2}-\d{4}$/.test(s)) return s;
  if(/^\d{2}-\d{4}$/.test(s)) return '01-' + s; // treat as 1st day -> convert
  const dt = new Date(s);
  if(!isNaN(dt)){
    const dd = String(dt.getDate()).padStart(2,'0'), mm = String(dt.getMonth()+1).padStart(2,'0'), yy = dt.getFullYear();
    return dd + '-' + mm + '-' + yy;
  }
  return s;
}
function fmtExpiryMMYYYY(v){
  if(!v) return '';
  const s = String(v).trim();
  if(/^\d{2}-\d{4}$/.test(s)) return s;
  const dt = new Date(s);
  if(!isNaN(dt)) return String(dt.getMonth()+1).padStart(2,'0') + '-' + dt.getFullYear();
  const parts = s.split(/[-\/]/);
  if(parts.length===3) return parts[1].padStart(2,'0') + '-' + (parts[2].length===2? '20'+parts[2] : parts[2]);
  return s;
}
function parseDDMMYYYY(str) {
  if (!str) return null;
  const s = String(str).trim();

  // If format is DD-MM-YYYY
  if (/^\d{2}-\d{2}-\d{4}$/.test(s)) {
    const [dd, mm, yyyy] = s.split('-').map(Number);
    return new Date(yyyy, mm - 1, dd);
  }

  const d = new Date(s);
  return isNaN(d) ? null : d;
}

function getExpiryStatusClass(expiryValue) {
  if (!expiryValue) return '';

  const expiryStr = String(expiryValue).trim();
  if (!/^\d{2}-\d{4}$/.test(expiryStr)) return '';

  const [mm, yyyy] = expiryStr.split('-').map(Number);

  // Expiry = LAST DAY of month
  const expDate = new Date(yyyy, mm, 0); 
  expDate.setHours(23,59,59,999);

  const today = new Date();
  today.setHours(0,0,0,0);

  const sixMonthsLater = new Date();
  sixMonthsLater.setMonth(sixMonthsLater.getMonth() + 6);

  if (expDate < today) {
    return 'text-red-600 font-bold';       // ðŸ”´ Expired
  }

  if (expDate >= today && expDate <= sixMonthsLater) {
    return 'text-orange-500 font-semibold'; // ðŸŸ  Short Expiry
  }

  return '';
}

/* Generic Chart Helper - Updated for stability */
function createChart(chartId, type, data, options = {}) {
  if (chartInstances[chartId]) {
    chartInstances[chartId].destroy();
  }
  const canvas = document.getElementById(chartId);
  if (!canvas) {
    console.error('Canvas element not found for chartId:', chartId);
    return;
  }
  const ctx = canvas.getContext('2d');
  
  // Default options for cleaner modern look - maintainAspectRatio: false is key for fixed containers
  const defaultOptions = {
      responsive: true,
      maintainAspectRatio: false, // Prevents the chart from resizing wildly and causing scroll issues
      plugins: {
          legend: { position: 'bottom', labels: { usePointStyle: true, boxWidth: 6, padding: 20 } },
          title: { display: false }
      },
      scales: {
          x: { grid: { display: false } },
          y: { beginAtZero: true, grid: { color: 'rgba(0, 0, 0, 0.05)' } }
      }
  };

  chartInstances[chartId] = new Chart(ctx, { 
    type, 
    data, 
    options: {
  ...defaultOptions,
  ...options
}
  });
}

/* ---------- Loaders & Selectors ---------- */
async function loadAll(){
  const [invR, prodR, staffR, recR, supR] = await Promise.all([
    post('getInventory', {}),
    post('getProducts', {}),
    post('getEmployeeList', {}),
    post('getAllReceipts', {}),
    post('getAllSupplies', {})
  ]);
  inventory = (invR && invR.success) ? invR.rows : [];
  products = (prodR && prodR.success) ? prodR.products : [];
  staff = (staffR && staffR.success) ? staffR.employees : [];
  receipts = (recR && recR.success) ? recR.receipts : [];
  supplies = (supR && supR.success) ? supR.supplies : [];

  populateSelectors();
}

function populateSelectors(){
  const typeSet = [...new Set(inventory.map(i => i.Type).filter(Boolean))].sort();
  const ft = document.getElementById('filterType');
  ft.innerHTML = '<option value="">All</option>' + typeSet.map(t => `<option>${escapeHtml(t)}</option>`).join('');

  const pSel = document.getElementById('ledgerProduct');
  pSel.innerHTML =
  '<option value="">-- Select Product --</option>' +
  '<option value="ALL">All Products</option>' +
  products.map(p => `<option>${escapeHtml(p.Product || p['Item Name'] || '')}</option>`).join('');

  const eSel = document.getElementById('ledgerEmployee');
  eSel.innerHTML = '<option value="">-- Select Employee --</option>' + staff.map(s => `<option value="${escapeHtml(s['Employee Code'])}">${escapeHtml(s['Employee Code'])} - ${escapeHtml(s['Employee Name'])}</option>`).join('');

  teams = [...new Set(supplies.map(s => s.Team).filter(Boolean))].sort();
  const teamSel = document.getElementById('filterTeam');
  teamSel.innerHTML = '<option value="">All Teams</option>' + teams.map(t => `<option>${escapeHtml(t)}</option>`).join('');
}

/* Mobile Sidebar Toggle */
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const backdrop = document.getElementById('sidebarBackdrop');
  sidebar.classList.toggle('open');
  backdrop.classList.toggle('hidden');
}

/* ---------- Tab switching ---------- */
function switchTab(e, force){
  const target = force || (e && e.currentTarget && e.currentTarget.dataset.target);
  if(!target) return;
  currentTab = target;
  document.getElementById('activeLabel').textContent = ({
    stock:'Stock Summary', minStock:'Minimum Stock', expiry:'Expiry Tracker', receipts:'Receipts Summary',
    teamSupply:'Team Supply Report', productLedger:'Product Ledger', employeeLedger:'Employee Ledger', employeeDistribution:'Employee Distribution', productDistribution:'Product Distribution'
  })[target] || target;
  
  document.querySelectorAll('.panel').forEach(p => p.classList.add('hidden', 'shadow-lg'));
  const el = document.getElementById(target); if(el) el.classList.remove('hidden');

  document.querySelectorAll('.sidebtn').forEach(b => b.classList.remove('tab-active'));
  document.querySelectorAll('.sidebtn').forEach(b => { if(b.dataset.target === target) b.classList.add('tab-active'); });

  // Hide sidebar on mobile after selection
  if (window.innerWidth < 768) { toggleSidebar(); }

  // auto-render
  renderForCurrentTab();
}

/* ---------- Renderers ---------- */
function renderStock(){
  const tbody = document.querySelector('#stockTable tbody'); tbody.innerHTML = '';
  const typeValueMap = {};
  let totalValue = 0;
  const uniqueProducts = new Set();
  const minThreshold = Number(document.getElementById('minThreshold').value || 20);
  let lowStockCount = 0;
  let count = 0;

  const filtered = getFilteredData(inventory, 'Last Updated');

filtered
  .filter(r => num(r.Qty) > 0)   // ðŸ”¥ Hide zero stock
  .forEach(r => {
    const value = num(r.Qty) * num(r.MRP);
    totalValue += value;

    // Data for charts/cards
    const type = r.Type || 'Uncategorized';
    typeValueMap[type] = (typeValueMap[type] || 0) + value;
    uniqueProducts.add(r.Product);
    if (num(r.Qty) < minThreshold) { lowStockCount++; }

    // Table rendering
    const tr = document.createElement('tr');
    // Updated 'Value' column to include â‚¹
    tr.innerHTML = `<td class="p-3">${escapeHtml(r.Type||'')}</td><td class="p-3">${escapeHtml(r.Product||'')}</td><td class="p-3">${escapeHtml(r.Batch||'')}</td><td class="p-3 ${getExpiryStatusClass(r.Expiry)}">
  ${escapeHtml(fmtExpiryMMYYYY(r.Expiry||''))}
</td><td class="p-3 text-right font-medium">${r.Qty||0}</td><td class="p-3 text-right">${num(r.MRP).toFixed(2)||''}</td><td class="p-3 text-right font-semibold text-indigo-600">â‚¹${value.toFixed(2)||''}</td><td class="p-3 text-left text-xs text-slate-500">${escapeHtml(fmtDDMMYYYY(r['Last Updated']||r['Receipt Date']||''))}</td>`;
    tbody.appendChild(tr);
    count++;
  });

  // Render Summary Cards
  document.getElementById('stockCount').textContent = count;
  document.getElementById('totalStockValue').textContent = 'â‚¹' + totalValue.toFixed(2);
  document.getElementById('uniqueProductsCount').textContent = uniqueProducts.size;
  document.getElementById('minStockBatches').textContent = lowStockCount;

}

let consolidatedMode = 'value';

function renderProductConsolidatedChart(){

  if(!inventory || inventory.length === 0) return;

  const canvas = document.getElementById('productConsolidatedChart');
  if(!canvas) return;

  const filtered = getFilteredData(inventory, 'Last Updated')
    .filter(r => num(r.Qty) > 0);

  const map = {};

  filtered.forEach(r => {
    const product = r.Product || 'Unknown';

    if(!map[product]){
      map[product] = { qty:0, value:0 };
    }

    map[product].qty += num(r.Qty);
    map[product].value += num(r.Qty) * num(r.MRP);
  });

  // Convert to array & SORT descending
  let dataArray = Object.keys(map).map(p => ({
    product: p,
    qty: map[p].qty,
    value: map[p].value
  }));

  dataArray.sort((a,b) => 
    consolidatedMode === 'value'
      ? b.value - a.value
      : b.qty - a.qty
  );

  // Show only Top 10
  dataArray = dataArray.slice(0, 10);

  const labels = dataArray.map(d => d.product);
  const values = dataArray.map(d =>
    consolidatedMode === 'value' ? d.value : d.qty
  );

  const colors = labels.map((_, i) =>
    `hsl(${(i*35)%360} 70% 55%)`
  );

  createChart('productConsolidatedChart','bar',{
  labels: labels,
  datasets: [{
    label: consolidatedMode === 'value'
      ? 'Top 10 Products - Stock Value (â‚¹)'
      : 'Top 10 Products - Quantity',
    data: values,
    backgroundColor: colors,
    borderRadius: 6
  }]
},{
  indexAxis: 'y',
  onClick: function(evt, elements){
    if(elements.length > 0){
      const index = elements[0].index;
      const productName = labels[index];
      openProductDetailPopup(productName);
    }
  },
  scales: {
    x: {
      ticks: {
        callback: function(value){
          return consolidatedMode === 'value'
            ? 'â‚¹' + Number(value).toLocaleString()
            : value;
        }
      }
    }
  },
  plugins:{
    legend:{ display:false }
  }
});
}

function renderMinStock(){
  const th = Number(document.getElementById('minThreshold').value || 20);
  const tbody = document.querySelector('#minTable tbody'); tbody.innerHTML = '';
  
const filtered = getFilteredData(inventory, 'Last Updated');

const lowStock = filtered
    .filter(i => num(i.Qty) < th)
    .sort((a,b) => num(a.Qty) - num(b.Qty)); // Sort by lowest quantity

  // Chart data: Top 5 Critical Batches
  const top5 = lowStock.slice(0, 5);
  const chartLabels = top5.map(r => `${r.Product} (${r.Batch})`);
  const chartValues = top5.map(r => num(r.Qty));

  createChart('minStockTop5Chart', 'bar', {
    labels: chartLabels,
    datasets: [{
      label: 'Current Quantity',
      data: chartValues,
      backgroundColor: 'rgba(239, 68, 68, 0.7)', // Red
      borderColor: 'rgba(239, 68, 68, 1)',
      borderWidth: 1,
      borderRadius: 4
    }]
  }, {
    scales: { x: { reverse: true } }, // Show lowest first
    indexAxis: 'y', // Horizontal bars
  });

  // Table rendering
  lowStock.forEach(r => {
    const val = num(r.Qty) * num(r.MRP);
    const tr = document.createElement('tr');
    // Updated 'Value' column to include â‚¹
    tr.innerHTML = `<td class="p-3">${escapeHtml(r.Product||'')}</td><td class="p-3">${escapeHtml(r.Batch||'')}</td><td class="p-3 ${getExpiryStatusClass(r.Expiry)}">
  ${escapeHtml(fmtExpiryMMYYYY(r.Expiry||''))}
</td><td class="p-3 text-right font-semibold text-red-600">${r.Qty||0}</td><td class="p-3 text-right">${num(r.MRP).toFixed(2)||''}</td><td class="p-3 text-right">â‚¹${val.toFixed(2)||''}</td><td class="p-3">${escapeHtml(r.Type||'')}</td>`;
    tbody.appendChild(tr);
  });
}

function renderExpiry(){
  const days = Number(document.getElementById('expiryDays').value || 30);
  const tbody = document.querySelector('#expiryTable tbody'); tbody.innerHTML = '';
  const now = new Date();
  const expiringItems = [];

  // Month map for charting
  const expiryMonthMap = {};
  const monthOrder = []; // To keep months in chronological order

  const filtered = getFilteredData(inventory, 'Last Updated');

filtered.forEach(r => {
    if(!r.Expiry) return;
    let expDate = null;
    let expiryStr = String(r.Expiry).trim();
    
    // Attempt to parse date
    if(/^\d{2}-\d{4}$/.test(expiryStr)){
      const [mm,yy] = expiryStr.split('-');
      expDate = new Date(Number(yy), Number(mm)-1, 1);
    } else {
      const dt = new Date(expiryStr);
      if(!isNaN(dt)) expDate = dt;
    }

    if(!expDate) return;
    
    // Check if the date is actually set to the first day of the month for comparison
    const year = expDate.getFullYear();
    const month = expDate.getMonth();
    const expiryMonthKey = `${String(month + 1).padStart(2, '0')}-${year}`;

    // Get the last day of the expiry month for accurate diff calculation
    const lastDayOfMonth = new Date(year, month + 1, 0); 
    const diff = Math.ceil((lastDayOfMonth - now) / (1000 * 60 * 60 * 24));
    
    if(diff <= days && diff > 0){
      expiringItems.push({...r, diff: diff});
    }

    if(diff > 0 && diff <= 365){ // For chart: show next year of expiries
      expiryMonthMap[expiryMonthKey] = (expiryMonthMap[expiryMonthKey] || 0) + 1;
      if (!monthOrder.includes(expiryMonthKey)) {
        monthOrder.push(expiryMonthKey);
      }
    }
  });

  // Sort months chronologically
  monthOrder.sort((a, b) => {
    const [m1, y1] = a.split('-').map(Number);
    const [m2, y2] = b.split('-').map(Number);
    if (y1 !== y2) return y1 - y2;
    return m1 - m2;
  });
  
  // Prepare chart data
  const chartLabels = monthOrder.map(key => key);
  const chartValues = monthOrder.map(key => expiryMonthMap[key]);

  createChart('expiryByMonthChart', 'bar', {
    labels: chartLabels,
    datasets: [{
      label: 'Batches Expiring',
      data: chartValues,
      backgroundColor: 'rgba(251, 191, 36, 0.7)', // Amber
      borderColor: 'rgba(251, 191, 36, 1)',
      borderWidth: 1,
      borderRadius: 4
    }]
  });

  // Table rendering
  expiringItems.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="p-3">${escapeHtml(r.Product||'')}</td><td class="p-3">${escapeHtml(r.Batch||'')}</td><td class="p-3 ${getExpiryStatusClass(r.Expiry)}">
  ${escapeHtml(fmtExpiryMMYYYY(r.Expiry||''))}
</td><td class="p-3 text-right">${r.Qty||0}</td><td class="p-3 text-right font-semibold text-amber-700">${r.diff}</td>`;
    tbody.appendChild(tr);
  });
}

function renderReceipts(){
  const tbody = document.querySelector('#receiptsTable tbody'); tbody.innerHTML = '';
  const filtered = getFilteredData(receipts, 'Date');

filtered.forEach(r => {
    const tr = document.createElement('tr');
    // Updated 'Amount' column to include â‚¹
    tr.innerHTML = `<td class="p-3">${escapeHtml(fmtDDMMYYYY(r.Date||r['Received Date']||''))}</td><td class="p-3">${escapeHtml(r['Receipt ID']||'')}</td><td class="p-3">${escapeHtml(r['Item Name']||r['Item']||'')}</td><td class="p-3">${escapeHtml(r.Batch||'')}</td><td class="p-3 ${getExpiryStatusClass(r.Expiry)}">
  ${escapeHtml(fmtExpiryMMYYYY(r.Expiry||''))}
</td><td class="p-3 text-right">${r['Received Qty']||r.Qty||0}</td><td class="p-3">${escapeHtml(r['Supplier Name']||'')}</td><td class="p-3 text-right font-medium text-emerald-600">â‚¹${num(r['Total Value']||r.Amount||0).toFixed(2)}</td>`;
    tbody.appendChild(tr);
  });
// âœ… Receipts Summary
let totalCount = 0, totalQty = 0, totalValue = 0;

filtered.forEach(r=>{
  totalCount++;
  totalQty += num(r['Received Qty'] || r.Qty);
  totalValue += num(r['Total Value'] || r.Amount);
});

document.getElementById('rsCount').textContent = totalCount;
document.getElementById('rsQty').textContent = totalQty;
document.getElementById('rsValue').textContent = 'â‚¹'+totalValue.toFixed(2);
}

/* Team summary + pie chart + table */
let teamPieChart = null; 

function renderTeamSummary(){

  const team = document.getElementById('filterTeam').value;
  const f = document.getElementById('teamFrom').value;
  const t = document.getElementById('teamTo').value;

  const filtered = supplies.filter(s => {

    if(team && s.Team !== team) return false;

    if(f || t){
      const rawDate = s.Date || s['Supply Date'] || s.DateRaw || s['Date'];
      const d = parseDDMMYYYY(rawDate);
      if(!d) return false;

      if(f && new Date(f) > d) return false;
      if(t && new Date(t) < d) return false;
    }

    return true;
  });

  const map = {};

filtered.forEach(s => {

    const teamName = s.Team || 'Unknown';

    if(!map[teamName]){
      map[teamName] = {
        count: 0,
        value: 0
      };
    }

    map[teamName].count += 1;
    map[teamName].value += num(s['Total Value'] || 0);

  });

  const tbody = document.querySelector('#teamSummaryTable tbody'); tbody.innerHTML = '';
  const labels = [], values = [];
  Object.keys(map).forEach(team => {
    labels.push(team);
    values.push(map[team].value);
    const tr = document.createElement('tr');
    // Updated 'Total Value' column to include â‚¹
    tr.innerHTML = `<td class="p-3">${escapeHtml(team)}</td><td class="p-3 text-right">${map[team].count}</td><td class="p-3 text-right font-medium text-indigo-600">â‚¹${map[team].value.toFixed(2)}</td>`;
    tbody.appendChild(tr);
  });

// Sort descending
const sorted = labels.map((l,i)=>({
  label:l,
  value:values[i]
})).sort((a,b)=>b.value-a.value);

// ðŸ”¥ Show Top 6 only
const top = sorted.slice(0,10);
const others = sorted.slice(10);

let finalLabels = top.map(x=>x.label);
let finalValues = top.map(x=>x.value);

if(others.length > 0){
  const othersTotal = others.reduce((a,b)=>a+b.value,0);
  finalLabels.push('Others');
  finalValues.push(othersTotal);
}

const total = finalValues.reduce((a,b)=>a+b,0);

const colors = finalLabels.map((_,i)=>
  `hsl(${i*45 % 360} 70% 55%)`
);

if(teamPieChart) teamPieChart.destroy();

createChart('teamPie', 'doughnut', {
  labels: finalLabels,
  datasets: [{
    data: finalValues,
    backgroundColor: colors,
    borderWidth: 2
  }]
},{
  cutout: '60%',
  plugins:{
    legend:{
      position:'bottom',
      labels:{
        boxWidth:12,
        padding:15
      }
    },
    tooltip:{
      callbacks:{
        label:function(ctx){
          const value = ctx.raw;
          const percent = ((value/total)*100).toFixed(1);
          return `${ctx.label}: â‚¹${value.toLocaleString()} (${percent}%)`;
        }
      }
    }
  }
});

teamPieChart = chartInstances['teamPie']; // Update reference
}

function renderTeamSupply(){
  const team = document.getElementById('filterTeam').value;
  const f = document.getElementById('teamFrom').value;
  const t = document.getElementById('teamTo').value;
  const tbody = document.querySelector('#teamSupplyTable tbody'); tbody.innerHTML = '';

  const baseFiltered = supplies;

const rows = baseFiltered.filter(s => {
    if(team && s.Team !== team) return false;
    if(f || t){
      const rawDate = s.Date || s['Supply Date'] || s.DateRaw || s['Date'];
const d = parseDDMMYYYY(rawDate);
if (!d) return false;
      if(f && new Date(f) > d) return false;
      if(t && new Date(t) < d) return false;
    }
    return true;
  });

  rows.forEach(r => {
    const code = r['Supply to (Emp ID)'] || r['Supply to'] || r['Employee Code'] || '';
    const st = staff.find(x => String(x['Employee Code']).trim() === String(code).trim()) || {};
    const tr = document.createElement('tr');
    // Updated 'Total Value' column to include â‚¹
    tr.innerHTML = `<td class="p-3">${escapeHtml(fmtDDMMYYYY(r.Date||''))}</td><td class="p-3">${escapeHtml(r.Team||'')}</td><td class="p-3">${escapeHtml(code)}</td><td class="p-3">${escapeHtml(st['Employee Name']||r['Emp Name']||'')}</td><td class="p-3">${escapeHtml(st['Designation']||r.Designation||'')}</td><td class="p-3">${escapeHtml(r['Item Supplied']||r['Item Name']||r.Product||'')}</td><td class="p-3">${escapeHtml(r['Batch No']||r.Batch||'')}</td><td class="p-3 ${getExpiryStatusClass(r.Expiry)}">
  ${escapeHtml(fmtExpiryMMYYYY(r.Expiry||''))}
</td><td class="p-3 text-right">${r.Qty||0}</td><td class="p-3 text-right font-medium text-red-600">â‚¹${num(r['Total Value']||0).toFixed(2)}</td><td class="p-3">${escapeHtml(r.Remarks||'')}</td>`;
    tbody.appendChild(tr);
  });
}

/* Product ledger - FIXED: MRP lookup added */
async function renderProductLedger(){
  const product = document.getElementById('ledgerProduct').value;
  const tbody = document.querySelector('#prodLedgerTable tbody');
  tbody.innerHTML = '';

  if(!product){
    tbody.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-slate-500">
      Please select a product from the dropdown above.
    </td></tr>`;
    return;
  }

  let rows = [];

// Build ledger from receipts & supplies (Correct Logic)
let ledgerMap = {};

const filteredReceipts = receipts;
const filteredSupplies = supplies;

// RECEIVED
filteredReceipts.forEach(r => {
  const p = r['Item Name'] || r.Product || '';
  const b = r.Batch || '';
  if(product !== "ALL" && p !== product) return;

  const key = p + '||' + b;

  if(!ledgerMap[key]){
    ledgerMap[key] = {
      ProductName: p,
      Batch: b,
      Expiry: r.Expiry || '',
      Received: 0,
      Supplied: 0,
      MRP: num(r.MRP || 0)
    };
  }

  ledgerMap[key].Received += num(r['Received Qty'] || r.Qty || 0);
});

// SUPPLIED
filteredSupplies.forEach(r => {
  const p = r.Product || r['Item Supplied'] || r['Item Name'] || '';
  const b = r.Batch || r['Batch No'] || '';
  if(product !== "ALL" && p !== product) return;

  const key = p + '||' + b;

  if(!ledgerMap[key]){
    ledgerMap[key] = {
      ProductName: p,
      Batch: b,
      Expiry: r.Expiry || '',
      Received: 0,
      Supplied: 0,
      MRP: 0
    };
  }

  ledgerMap[key].Supplied += num(r.Qty || 0);
});

rows = Object.values(ledgerMap).map(r => {
  r.Balance = r.Received - r.Supplied;
  return r;
});


  if(rows.length === 0){
    tbody.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-slate-500">
      No ledger data found.
    </td></tr>`;
    return;
  }
// âœ… Product Ledger Summary
let totalReceived = 0, totalSupplied = 0, totalRemaining = 0, totalValue = 0;

rows.forEach(r=>{
  totalReceived += num(r.Received);
  totalSupplied += num(r.Supplied);
  totalRemaining += num(r.Balance);
  totalValue += num(r.Balance) * num(r.MRP);
});

document.getElementById('plProducts').textContent =
  product === "ALL" ? new Set(rows.map(r=>r.ProductName)).size : 1;

document.getElementById('plBatches').textContent = rows.length;
document.getElementById('plReceived').textContent = totalReceived;
document.getElementById('plSupplied').textContent = totalSupplied;
document.getElementById('plRemaining').textContent = totalRemaining;
document.getElementById('plValue').textContent = 'â‚¹'+totalValue.toFixed(2);

  rows.forEach(r => {
    const remainingQty = num(r.Balance);
    const totalValue = remainingQty * num(r.MRP);

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="p-3">${escapeHtml(r.ProductName||'')}</td>
      <td class="p-3">${escapeHtml(r.Batch||'')}</td>
      <td class="p-3 ${getExpiryStatusClass(r.Expiry)}">
        ${escapeHtml(fmtExpiryMMYYYY(r.Expiry||''))}
      </td>
      <td class="p-3 text-right text-emerald-600 font-medium">${r.Received||0}</td>
      <td class="p-3 text-right text-red-600 font-medium">${r.Supplied||0}</td>
      <td class="p-3 text-right font-bold">${remainingQty}</td>
      <td class="p-3 text-right font-bold text-indigo-600">â‚¹${totalValue.toFixed(2)}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* Employee ledger - FIXED: MRP lookup added */
async function renderEmployeeLedger(){
  const empCode = document.getElementById('ledgerEmployee').value;
  const tbody = document.querySelector('#empLedgerTable tbody'); tbody.innerHTML = '';
  if(!empCode) { tbody.innerHTML = `<tr><td colspan="10" class="p-4 text-center text-slate-500">Please select an employee from the dropdown above.</td></tr>`; return; }

  const res = await post('getReportData', { reportType: 'employeeLedger', employee: empCode });
  if(!res || !res.success || (res.rows || []).length === 0){ 
    tbody.innerHTML = `<tr><td colspan="10" class="p-4 text-center text-slate-500">${escapeHtml(res.message || 'No supply data found for this employee.')}</td></tr>`; return; 
  }
  
  (res.rows || []).forEach(r => {
    const qty = num(r.Qty || 0);
    let mrp = num(r.MRP || 0);
    const product = r.Product || r['Item Supplied'] || '';
    const batch = r.Batch || '';

    // FIX: Fallback MRP lookup if the backend didn't provide it (which is common for supplies)
    if (mrp === 0 && product && batch) {
        const inventoryItem = inventory.find(i => 
            String(i.Product).trim() === String(product).trim() && 
            String(i.Batch).trim() === String(batch).trim()
        );
        if (inventoryItem) {
            mrp = num(inventoryItem.MRP);
        }

    }

    // Calculate total value using the fetched/looked-up MRP
    const totalValue = num(r['Total Value'] || (qty * mrp));

    const tr = document.createElement('tr');
    // Updated Total Value to include â‚¹
    tr.innerHTML = `<td class="p-3">${escapeHtml(r.Date||'')}</td><td class="p-3">${escapeHtml(r['Employee Code']||'')}</td><td class="p-3">${escapeHtml(r['Employee Name']||'')}</td><td class="p-3">${escapeHtml(r['Designation']||'')}</td><td class="p-3">${escapeHtml(r.Product||r['Item Supplied']||'')}</td><td class="p-3">${escapeHtml(r.Batch||'')}</td><td class="p-3">${escapeHtml(r.Expiry||'')}</td><td class="p-3 text-right font-medium">${qty}</td><td class="p-3 text-right font-medium text-red-600">â‚¹${totalValue.toFixed(2)}</td><td class="p-3">${escapeHtml(r.Remarks||'')}</td>`;
    tbody.appendChild(tr);
  });
// âœ… Employee Ledger Summary (Correct Placement)
let totalTrans = 0, totalQty = 0, totalValue = 0;

(res.rows || []).forEach(r=>{
  totalTrans++;
  totalQty += num(r.Qty || 0);
  const qty = num(r.Qty || 0);
let mrp = num(r.MRP || 0);

// fallback MRP lookup (same logic used above)
if (mrp === 0 && r.Product && r.Batch) {
  const inventoryItem = inventory.find(i =>
    String(i.Product).trim() === String(r.Product).trim() &&
    String(i.Batch).trim() === String(r.Batch).trim()
  );
  if (inventoryItem) {
    mrp = num(inventoryItem.MRP);
  }
}

const rowValue = num(r['Total Value'] || (qty * mrp));
totalValue += rowValue;
});

document.getElementById('elTrans').textContent = totalTrans;
document.getElementById('elQty').textContent = totalQty;
document.getElementById('elValue').textContent = 'â‚¹'+totalValue.toFixed(2);
}

function renderEmployeeDistribution(){
  const summaryBody = document.querySelector('#empDistSummaryTable tbody');
  const detailBody = document.querySelector('#empDistDetailTable tbody');
  summaryBody.innerHTML = '';
  detailBody.innerHTML = '';

  if(!supplies || supplies.length === 0){
    summaryBody.innerHTML = `
      <tr>
        <td colspan="5" class="p-4 text-center text-slate-500">
          No distribution data found.
        </td>
      </tr>`;
    return;
  }

  const empMap = {};
const filtered = getFilteredData(supplies, 'Date');

filtered.forEach(r => {

    const empCode =
      r['Supply to (Emp ID)'] ||
      r['Supply to'] ||
      r['Employee Code'] ||
      '';

    const empName =
      r['Emp Name'] ||
      r['Employee Name'] ||
      '';

    if(!empCode) return;

    if(!empMap[empCode]){
      empMap[empCode] = {
        name: empName,
        supIds: new Set(),
        totalQty: 0,
        totalValue: 0
      };
    }

    const supId =
      r['Supply ID'] ||
      r['SUP ID'] ||
      r['Distribution ID'] ||
      '';

    if(supId) empMap[empCode].supIds.add(supId);

    empMap[empCode].totalQty += num(r.Qty);
    empMap[empCode].totalValue += num(r['Total Value']);
  });

Object.entries(empMap)
  .sort((a, b) => b[1].totalValue - a[1].totalValue) // ðŸ”¥ DESCENDING VALUE
  .forEach(([empCode, data]) => {

    const tr = document.createElement('tr');
    tr.classList.add('cursor-pointer','hover:bg-indigo-50');

    tr.innerHTML = `
      <td class="p-3 font-medium">${empCode}</td>
      <td class="p-3">${escapeHtml(data.name || '')}</td>
      <td class="p-3 text-right">${data.supIds.size}</td>
      <td class="p-3 text-right">${data.totalQty}</td>
      <td class="p-3 text-right font-semibold text-indigo-600">â‚¹${data.totalValue.toFixed(2)}</td>
    `;

    tr.onclick = () => {
      renderEmployeeDistributionDetail(empCode);
      openEmpDistModal();
    };

    summaryBody.appendChild(tr);
});
// âœ… Staffwise Summary
let totalQty = 0, totalValue = 0;

Object.values(empMap).forEach(d=>{
  totalQty += d.totalQty;
  totalValue += d.totalValue;
});

document.getElementById('edTotalEmp').textContent = Object.keys(empMap).length;
document.getElementById('edTotalQty').textContent = totalQty;
document.getElementById('edTotalValue').textContent = 'â‚¹'+totalValue.toFixed(2);
}



function renderEmployeeDistributionDetail(empCode){

  const detailBody = document.querySelector('#empDistDetailTable tbody');
  detailBody.innerHTML = '';

  if(!supplies || supplies.length === 0) return;

  const filtered = getFilteredData(supplies, 'Date');

const rows = filtered.filter(r => {
    const code =
      r['Supply to (Emp ID)'] ||
      r['Supply to'] ||
      r['Employee Code'] ||
      '';

    return String(code).trim() === String(empCode).trim();
  });

  if(rows.length === 0){
    detailBody.innerHTML = `
      <tr>
        <td colspan="10" class="p-4 text-center text-slate-500">
          No detailed records found.
        </td>
      </tr>`;
    return;
  }

  rows.forEach(r => {

    const tr = document.createElement('tr');

    tr.innerHTML = `
      <td class="p-3">${escapeHtml(fmtDDMMYYYY(r.Date || r['Supply Date'] || ''))}</td>
      <td class="p-3">${escapeHtml(empCode)}</td>
      <td class="p-3">${escapeHtml(r['Emp Name'] || r['Employee Name'] || '')}</td>
      <td class="p-3">${escapeHtml(r.Designation || '')}</td>
      <td class="p-3">${escapeHtml(r.Product || r['Item Supplied'] || r['Item Name'] || '')}</td>
      <td class="p-3">${escapeHtml(r.Batch || r['Batch No'] || '')}</td>
      <td class="p-3 ${getExpiryStatusClass(r.Expiry)}">
        ${escapeHtml(fmtExpiryMMYYYY(r.Expiry || ''))}
      </td>
      <td class="p-3 text-right">${num(r.Qty)}</td>
      <td class="p-3 text-right font-medium text-red-600">
        â‚¹${num(r['Total Value']).toFixed(2)}
      </td>
      <td class="p-3">${escapeHtml(r.Remarks || '')}</td>
    `;

    detailBody.appendChild(tr);
  });
}


function renderProductDistribution(){

  const summaryBody = document.querySelector('#prodDistSummaryTable tbody');
  summaryBody.innerHTML = '';

  if(!supplies || supplies.length === 0){
    summaryBody.innerHTML = `
      <tr>
        <td colspan="4" class="p-4 text-center text-slate-500">
          No distribution data found.
        </td>
      </tr>`;
    return;
  }

  const productMap = {};
  const filtered = getFilteredData(supplies, 'Date');

  filtered.forEach(r => {

    const product =
      r.Product ||
      r['Item Supplied'] ||
      r['Item Name'] ||
      '';

    if(!product) return;

    if(!productMap[product]){
      productMap[product] = {
        supIds: new Set(),
        totalQty: 0,
        totalValue: 0
      };
    }

    const supId =
      r['Supply ID'] ||
      r['SUP ID'] ||
      r['Distribution ID'] ||
      '';

    if(supId) productMap[product].supIds.add(supId);

    productMap[product].totalQty += num(r.Qty);
    productMap[product].totalValue += num(r['Total Value']);
  });

  Object.entries(productMap)
    .sort((a,b)=> b[1].totalValue - a[1].totalValue) // Descending value
    .forEach(([product,data])=>{

      const tr = document.createElement('tr');
      tr.classList.add('cursor-pointer','hover:bg-indigo-50');

      tr.innerHTML = `
        <td class="p-3 font-medium">${escapeHtml(product)}</td>
        <td class="p-3 text-right">${data.supIds.size}</td>
        <td class="p-3 text-right">${data.totalQty}</td>
        <td class="p-3 text-right font-semibold text-indigo-600">â‚¹${data.totalValue.toFixed(2)}</td>
      `;

      tr.onclick = ()=>{
        renderProductDistributionDetail(product);
        openProdDistModal();
      };

      summaryBody.appendChild(tr);
    });

// âœ… Productwise Summary
let totalQty = 0, totalValue = 0;

Object.values(productMap).forEach(d=>{
  totalQty += d.totalQty;
  totalValue += d.totalValue;
});

document.getElementById('pdTotalProducts').textContent = Object.keys(productMap).length;
document.getElementById('pdTotalQty').textContent = totalQty;
document.getElementById('pdTotalValue').textContent = 'â‚¹'+totalValue.toFixed(2);
}

function renderProductDistributionDetail(product){

  const detailBody = document.querySelector('#prodDistDetailTable tbody');
  detailBody.innerHTML = '';

  const filtered = getFilteredData(supplies, 'Date');

  const rows = filtered.filter(r=>{
    const p = r.Product || r['Item Supplied'] || r['Item Name'] || '';
    return String(p).trim() === String(product).trim();
  });

  rows.forEach(r=>{
    const tr = document.createElement('tr');

  const empCode =
  r['Supply to (Emp ID)'] ||
  r['Supply to'] ||
  r['Employee Code'] ||
  '';

const empName =
  r['Emp Name'] ||
  r['Employee Name'] ||
  '';

tr.innerHTML = `
  <td class="p-3">${escapeHtml(fmtDDMMYYYY(r.Date||r['Supply Date']||''))}</td>
  <td class="p-3">${escapeHtml(empCode)}</td>
  <td class="p-3">${escapeHtml(empName)}</td>
  <td class="p-3">${escapeHtml(product)}</td>
  <td class="p-3">${escapeHtml(r.Batch||r['Batch No']||'')}</td>
  <td class="p-3 ${getExpiryStatusClass(r.Expiry)}">
    ${escapeHtml(fmtExpiryMMYYYY(r.Expiry||''))}
  </td>
  <td class="p-3 text-right">${num(r.Qty)}</td>
  <td class="p-3 text-right font-medium text-red-600">
    â‚¹${num(r['Total Value']).toFixed(2)}
  </td>
  <td class="p-3">${escapeHtml(r.Remarks||'')}</td>
`;

    detailBody.appendChild(tr);
  });
}

/* ---------- Export helpers (unchanged) ---------- */
function tableToCsv(table) {
  const rows = [];
  table.querySelectorAll('tr').forEach(tr => {
    const cols = [];
    tr.querySelectorAll('th,td').forEach(td => {
      let txt = td.textContent.replace(/\n+/g,' ').trim();
      cols.push('"' + txt.replace(/"/g,'""') + '"');
    });
    if(cols.length) rows.push(cols.join(','));
  });
  return rows.join('\n');
}

function downloadCsv(filename, csv) {
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url);
}

/* Export visible as CSV */
function exportCsvCurrent(){
  let tableId = 'stockTable';
  if(currentTab === 'minStock') tableId = 'minTable';
  else if(currentTab === 'expiry') tableId = 'expiryTable';
  else if(currentTab === 'receipts') tableId = 'receiptsTable';
  else if(currentTab === 'teamSupply') tableId = 'teamSupplyTable';
  else if(currentTab === 'productLedger') tableId = 'prodLedgerTable';
  else if(currentTab === 'employeeLedger') tableId = 'empLedgerTable';
  const table = document.getElementById(tableId);
  const csv = tableToCsv(table);
  downloadCsv(`${currentTab}_report_${new Date().toISOString().slice(0,10)}.csv`, csv);
}

/* Export current visible report as Excel (.xlsx) */
async function exportExcelCurrent(){
  if(currentTab === 'teamSupply'){

// Use already filtered frontend data
const team = document.getElementById('filterTeam').value;
const f = document.getElementById('teamFrom').value;
const t = document.getElementById('teamTo').value;

const allRows = supplies.filter(s => {
  if(team && s.Team !== team) return false;

  if(f || t){
    const rawDate = s.Date || s['Supply Date'] || s.DateRaw || s['Date'];
    const d = parseDDMMYYYY(rawDate);
    if(!d) return false;

    if(f && new Date(f) > d) return false;
    if(t && new Date(t) < d) return false;
  }

  return true;
});

    const summaryTable = document.getElementById('teamSummaryTable');
    const summarySheet = XLSX.utils.table_to_sheet(summaryTable, { raw:true });
Object.keys(summarySheet).forEach(key => {
    if (key[0] === '!') return;
    if (summarySheet[key].v && /^\d{2}-\d{2}-\d{4}$/.test(summarySheet[key].v)) {
        summarySheet[key].t = 's';
    }
});

const details = allRows.map(r => {

  const code = r['Supply to (Emp ID)'] || 
               r['Supply to'] || 
               r['Employee Code'] || '';

  const st = staff.find(x =>
      String(x['Employee Code']).trim() === String(code).trim()
  ) || {};

  return {
    Date: r.Date || '',
    Team: r.Team || '',
    'Employee Code': code,
    'Employee Name': st['Employee Name'] || r['Emp Name'] || '',
    Designation: st['Designation'] || r.Designation || '',
    Product: r.Product || r['Item Supplied'] || r['Item Name'] || '',
    Batch: r.Batch || r['Batch No'] || '',
    Expiry: r.Expiry || '',
    Qty: r.Qty || 0,
    'Total Value': r['Total Value'] || 0,
    Remarks: r.Remarks || ''
  };
});

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, summarySheet, 'Summary');

    if(details.length){
      const detSheet = XLSX.utils.json_to_sheet(details);
Object.keys(detSheet).forEach(key => {
    if (key[0] === '!') return;
    if (detSheet[key].v && /^\d{2}-\d{2}-\d{4}$/.test(detSheet[key].v)) {
        detSheet[key].t = 's'; // force Excel to treat as text
    }
});
      XLSX.utils.book_append_sheet(wb, detSheet, 'Details');
    } else {
      const empty = XLSX.utils.json_to_sheet([{Info:'No data found for selected filters'}]);
      XLSX.utils.book_append_sheet(wb, empty, 'Details');
    }

    XLSX.writeFile(wb, `team_supply_${team || 'all'}_${new Date().toISOString().slice(0,10)}.xlsx`);
    return;
  }

  // other tabs
  let tableId = 'stockTable';
  if(currentTab === 'minStock') tableId = 'minTable';
  else if(currentTab === 'expiry') tableId = 'expiryTable';
  else if(currentTab === 'receipts') tableId = 'receiptsTable';
  else if(currentTab === 'productLedger') tableId = 'prodLedgerTable';
  else if(currentTab === 'employeeLedger') tableId = 'empLedgerTable';

  const table = document.getElementById(tableId);
  const sheet = XLSX.utils.table_to_sheet(table, { raw: false });

Object.keys(sheet).forEach(key => {
    if (key[0] === '!') return; // skip metadata
    if (sheet[key].v && /^\d{2}-\d{2}-\d{4}$/.test(sheet[key].v)) {
        sheet[key].t = 's'; // force text
    }
});

const wb = XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb, sheet, "Report");
  XLSX.writeFile(wb, `${currentTab}_report_${new Date().toISOString().slice(0,10)}.xlsx`);
}

/* ---------- Wiring UI actions ---------- */
document.getElementById('refreshBtn').addEventListener('click', async () => { await loadAll(); renderForCurrentTab(); });
document.getElementById('goBtn').addEventListener('click', () => { renderForCurrentTab(); });
document.getElementById('exportCsvBtn').addEventListener('click', exportCsvCurrent);
document.getElementById('exportExcelBtn').addEventListener('click', exportExcelCurrent);
document.getElementById('refreshTeam').addEventListener('click', () => { renderTeamSummary(); renderTeamSupply(); });
document.getElementById('menuToggle').addEventListener('click', toggleSidebar); // New mobile toggle binding

async function renderForCurrentTab(){
  // Apply date and product type filters to the main inventory/supplies lists if needed before rendering.
  // For this application, filtering is handled by the `post` calls in ledgers or is simple in-memory in other render functions.
  // For complex filtering, you'd call a new API function here. Since we don't have that, we render as is.
if(currentTab === 'stock'){
  renderStock();
  renderProductConsolidatedChart();
}
else if(currentTab === 'dashboard') renderDashboard();  
else if(currentTab === 'minStock') renderMinStock();
  else if(currentTab === 'expiry') renderExpiredSummary();
  else if(currentTab === 'receipts') renderReceipts();
  else if(currentTab === 'teamSupply') { renderTeamSummary(); renderTeamSupply(); }
  else if(currentTab === 'productLedger') renderProductLedger();
  else if(currentTab === 'employeeLedger') renderEmployeeLedger();
else if(currentTab === 'employeeDistribution') renderEmployeeDistribution();
else if(currentTab === 'productDistribution') renderProductDistribution();
autoFormatSummaryCards();
}

function openEmpDistModal(){
  const modal = document.getElementById('empDistModal');
  modal.classList.remove('hidden');
  modal.classList.add('flex');
}

function closeEmpDistModal(){
  const modal = document.getElementById('empDistModal');
  modal.classList.add('hidden');
  modal.classList.remove('flex');
}

function openProdDistModal(){
  const modal = document.getElementById('prodDistModal');
  modal.classList.remove('hidden');
  modal.classList.add('flex');
}

function closeProdDistModal(){
  const modal = document.getElementById('prodDistModal');
  modal.classList.add('hidden');
  modal.classList.remove('flex');
}

/* ---------- Initial load ---------- */
(async ()=>{
  await loadAll();
  switchTab(null, 'dashboard');
})();


document.addEventListener('DOMContentLoaded', function(){

  const valBtn = document.getElementById('toggleValue');
  const qtyBtn = document.getElementById('toggleQty');

  if(valBtn && qtyBtn){

    valBtn.onclick = () => {
      consolidatedMode = 'value';
      renderProductConsolidatedChart();
    };

    qtyBtn.onclick = () => {
      consolidatedMode = 'qty';
      renderProductConsolidatedChart();
    };
  }

});


document.addEventListener('DOMContentLoaded', function(){

  const valBtn = document.getElementById('toggleValue');
  const qtyBtn = document.getElementById('toggleQty');

  if(!valBtn || !qtyBtn) return;

  function updateToggleUI(){
    if(consolidatedMode === 'value'){
      valBtn.classList.add('bg-indigo-600','text-white');
      valBtn.classList.remove('border');

      qtyBtn.classList.remove('bg-indigo-600','text-white');
      qtyBtn.classList.add('border');
    } else {
      qtyBtn.classList.add('bg-indigo-600','text-white');
      qtyBtn.classList.remove('border');

      valBtn.classList.remove('bg-indigo-600','text-white');
      valBtn.classList.add('border');
    }
  }

  valBtn.onclick = () => {
    consolidatedMode = 'value';
    updateToggleUI();
    renderProductConsolidatedChart();
  };

  qtyBtn.onclick = () => {
    consolidatedMode = 'qty';
    updateToggleUI();
    renderProductConsolidatedChart();
  };

});

function openProductDetailPopup(productName){

  const rows = inventory.filter(r =>
    r.Product === productName && num(r.Qty) > 0
  );

  if(rows.length === 0) return;

  let html = `
  <div class="fixed inset-0 bg-black/40 flex items-center justify-center z-50" id="prodPopup">
    <div class="bg-white w-[90%] max-w-4xl rounded-xl shadow-xl p-6 relative">
      <button onclick="document.getElementById('prodPopup').remove()"
        class="absolute top-3 right-3 text-red-600 font-bold text-lg">âœ•</button>

      <h3 class="text-xl font-bold mb-4">${productName} - Batch Details</h3>

      <div class="overflow-x-auto border rounded-lg">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-50">
            <tr>
              <th class="p-3 text-left">Product Name</th>
              <th class="p-3 text-left">Batch</th>
              <th class="p-3 text-left">Expiry</th>
              <th class="p-3 text-right">Qty</th>
              <th class="p-3 text-right">MRP</th>
              <th class="p-3 text-right">Value</th>
            </tr>
          </thead>
          <tbody>
  `;

  rows.forEach(r=>{
    const value = num(r.Qty) * num(r.MRP);

    html += `
      <tr class="border-t">
        <td class="p-3">${r.Product}</td>
        <td class="p-3">${r.Batch}</td>
        <td class="p-3 ${getExpiryStatusClass(r.Expiry)}">
  ${escapeHtml(fmtExpiryMMYYYY(r.Expiry||''))}
</td>
        <td class="p-3 text-right">${r.Qty}</td>
        <td class="p-3 text-right">â‚¹${num(r.MRP).toFixed(2)}</td>
        <td class="p-3 text-right font-semibold text-indigo-600">
          â‚¹${value.toFixed(2)}
        </td>
      </tr>
    `;
  });

  html += `
          </tbody>
        </table>
      </div>
    </div>
  </div>`;

  document.body.insertAdjacentHTML('beforeend', html);
}

function renderExpiredSummary(){

  const tbody = document.querySelector('#expiryTable tbody');
  tbody.innerHTML = '';

  const today = new Date();
  today.setHours(0,0,0,0);

  const map = {};

  inventory.forEach(r => {

    if(!r.Expiry || num(r.Qty) <= 0) return;

    const expiryStr = fmtExpiryMMYYYY(r.Expiry);
    if(!/^\d{2}-\d{4}$/.test(expiryStr)) return;

    const [mm, yyyy] = expiryStr.split('-').map(Number);
    const expDate = new Date(yyyy, mm, 0);
    expDate.setHours(23,59,59,999);

    const sixMonthsLater = new Date();
    sixMonthsLater.setMonth(sixMonthsLater.getMonth()+6);

    const product = r.Product || 'Unknown';

    if(!map[product]){
      map[product] = {
        expiredQty:0,
        shortQty:0,
        mrp:num(r.MRP),
        value:0
      };
    }

    if(expDate < today){
  map[product].expiredQty += num(r.Qty);
}

if(expDate >= today && expDate <= sixMonthsLater){
  map[product].shortQty += num(r.Qty);
}

  });

  Object.keys(map)
  .map(product => {

    const d = map[product];
    const totalQty = d.expiredQty + d.shortQty;
    const totalValue = totalQty * d.mrp;

    return {
      product,
      expiredQty: d.expiredQty,
      shortQty: d.shortQty,
      mrp: d.mrp,
      totalValue
    };

  })
  .filter(d => d.expiredQty > 0 || d.shortQty > 0)

  // ðŸ”¥ SORT DESCENDING BY TOTAL VALUE
  .sort((a, b) => b.totalValue - a.totalValue)

  .forEach(d => {

    const tr = document.createElement('tr');
    tr.classList.add('cursor-pointer','hover:bg-red-50');

    tr.innerHTML = `
      <td class="p-3 font-semibold">${escapeHtml(d.product)}</td>
      <td class="p-3 text-right text-red-600 font-bold">${d.expiredQty}</td>
      <td class="p-3 text-right text-orange-500 font-semibold">${d.shortQty}</td>
      <td class="p-3 text-right">${d.mrp.toFixed(2)}</td>
      <td class="p-3 text-right font-bold text-indigo-600">
        â‚¹${d.totalValue.toFixed(2)}
      </td>
    `;

    tr.onclick = () => openExpiredDetailPopup(d.product);

    tbody.appendChild(tr);
  });

}

function openExpiredDetailPopup(productName){

  const today = new Date();
  today.setHours(0,0,0,0);

  const rows = inventory.filter(r => 
    r.Product === productName && num(r.Qty) > 0
  );

  if(rows.length === 0) return;

  let html = `
  <div class="fixed inset-0 bg-black/40 flex items-center justify-center z-50" id="expiredPopup">
    <div class="bg-white w-[95%] max-w-5xl rounded-xl shadow-xl p-6 relative">
      <button onclick="document.getElementById('expiredPopup').remove()"
        class="absolute top-3 right-3 text-red-600 font-bold text-lg">âœ•</button>

      <h3 class="text-xl font-bold mb-4">
        ${escapeHtml(productName)} - Batch Expiry Details
      </h3>

      <div class="overflow-x-auto border rounded-lg">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-50">
            <tr>
              <th class="p-3 text-left">Batch</th>
              <th class="p-3 text-left">Expiry</th>
              <th class="p-3 text-right">Qty</th>
              <th class="p-3 text-right">MRP</th>
              <th class="p-3 text-right">Value</th>
            </tr>
          </thead>
          <tbody>
  `;

  rows.forEach(r => {

    const value = num(r.Qty) * num(r.MRP);

    html += `
      <tr class="border-t">
        <td class="p-3">${escapeHtml(r.Batch||'')}</td>
        <td class="p-3 ${getExpiryStatusClass(r.Expiry)}">
          ${escapeHtml(fmtExpiryMMYYYY(r.Expiry||''))}
        </td>
        <td class="p-3 text-right">${r.Qty}</td>
        <td class="p-3 text-right">â‚¹${num(r.MRP).toFixed(2)}</td>
        <td class="p-3 text-right font-semibold text-indigo-600">
          â‚¹${value.toFixed(2)}
        </td>
      </tr>
    `;
  });

  html += `
          </tbody>
        </table>
      </div>
    </div>
  </div>`;

  document.body.insertAdjacentHTML('beforeend', html);
}


function renderDashboard(){

  const filteredInventory = inventory.filter(r => num(r.Qty) > 0);

  // TOTAL PRODUCTS (consolidated)
  const productSet = new Set(filteredInventory.map(r => r.Product));
  document.getElementById('dbTotalProducts').textContent = productSet.size;

  // TOTAL VALUE
  let totalValue = 0;
  filteredInventory.forEach(r=>{
    totalValue += num(r.Qty) * num(r.MRP);
  });
  document.getElementById('dbTotalValue').textContent = 'â‚¹'+totalValue.toFixed(2);

  // EXPIRY SUMMARY
  let expiredQty=0, expiredVal=0, shortQty=0, shortVal=0;

  const today = new Date(); today.setHours(0,0,0,0);
  const sixMonths = new Date(); sixMonths.setMonth(sixMonths.getMonth()+6);

  filteredInventory.forEach(r=>{
    if(!r.Expiry) return;
    const expiryStr = fmtExpiryMMYYYY(r.Expiry);
    if(!/^\d{2}-\d{4}$/.test(expiryStr)) return;

    const [mm,yy] = expiryStr.split('-').map(Number);
    const expDate = new Date(yy,mm,0);

    const value = num(r.Qty)*num(r.MRP);

    if(expDate < today){
      expiredQty += num(r.Qty);
      expiredVal += value;
    } else if(expDate <= sixMonths){
      shortQty += num(r.Qty);
      shortVal += value;
    }
  });

  document.getElementById('dbExpired').textContent =
    expiredQty+' / â‚¹'+expiredVal.toFixed(2);

  document.getElementById('dbShortExpiry').textContent =
    shortQty+' / â‚¹'+shortVal.toFixed(2);

  document.getElementById('dbReceipts').textContent = receipts.length;
  document.getElementById('dbSupplies').textContent = supplies.length;

  // PRODUCT CHART (Top 10 by value)
  const productMap = {};
  filteredInventory.forEach(r=>{
    productMap[r.Product] =
      (productMap[r.Product]||0) + num(r.Qty)*num(r.MRP);
  });

  const sortedProducts = Object.entries(productMap)
    .sort((a,b)=>b[1]-a[1])
    .slice(0,10);

  createChart('dbProductChart','bar',{
    labels: sortedProducts.map(x=>x[0]),
    datasets:[{
      label:'Stock Value',
      data: sortedProducts.map(x=>x[1]),
      backgroundColor:'rgba(79,70,229,0.7)',
      borderRadius:6
    }]
  });

  // PRODUCT TYPE CHART
  const typeMap = {};
  filteredInventory.forEach(r=>{
    typeMap[r.Type] =
      (typeMap[r.Type]||0) + num(r.Qty)*num(r.MRP);
  });

  createChart('dbTypeChart','pie',{
    labels:Object.keys(typeMap),
    datasets:[{
      data:Object.values(typeMap)
    }]
  });

  // TEAM SUPPLY CHART
  const teamMap = {};
  supplies.forEach(s=>{
    teamMap[s.Team] =
      (teamMap[s.Team]||0) + num(s['Total Value']);
  });

  createChart('dbTeamChart','doughnut',{
    labels:Object.keys(teamMap),
    datasets:[{
      data:Object.values(teamMap)
    }]
  });

  // PRODUCT DISTRIBUTION
  const distMap = {};
  supplies.forEach(s=>{
    const p = s.Product || s['Item Supplied'];
    distMap[p] = (distMap[p]||0) + num(s.Qty);
  });

  const sortedDist = Object.entries(distMap)
    .sort((a,b)=>b[1]-a[1])
    .slice(0,10);

  createChart('dbDistributionChart','bar',{
    labels: sortedDist.map(x=>x[0]),
    datasets:[{
      label:'Qty Distributed',
      data: sortedDist.map(x=>x[1]),
      backgroundColor:'rgba(16,185,129,0.7)',
      borderRadius:6
    }]
  });
// TOP 10 EMPLOYEES BY VALUE
const empMap = {};

supplies.forEach(s=>{
  const empCode = s['Supply to (Emp ID)'] || s['Employee Code'] || '';
  const empName = s['Employee Name'] || s['Emp Name'] || empCode;

  if(!empName) return;

  empMap[empName] =
    (empMap[empName] || 0) + num(s['Total Value'] || 0);
});

const topEmployees = Object.entries(empMap)
  .sort((a,b)=>b[1]-a[1])
  .slice(0,10);

const empTbody = document.getElementById('dbTopEmployees');
empTbody.innerHTML = '';

topEmployees.forEach(e=>{
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td class="p-3 font-medium">${escapeHtml(e[0])}</td>
    <td class="p-3 text-right font-semibold text-indigo-600">
      â‚¹${e[1].toFixed(2)}
    </td>
  `;
  empTbody.appendChild(tr);
});

// TOP 10 PRODUCTS BY DISTRIBUTION VALUE
const prodMap = {};

supplies.forEach(s=>{
  const product = s.Product || s['Item Supplied'] || '';
  if(!product) return;

  prodMap[product] =
    (prodMap[product] || 0) + num(s['Total Value'] || 0);
});

const topProducts = Object.entries(prodMap)
  .sort((a,b)=>b[1]-a[1])
  .slice(0,10);

const prodTbody = document.getElementById('dbTopProducts');
prodTbody.innerHTML = '';

topProducts.forEach(p=>{
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td class="p-3 font-medium">${escapeHtml(p[0])}</td>
    <td class="p-3 text-right font-semibold text-emerald-600">
      â‚¹${p[1].toFixed(2)}
    </td>
  `;
  prodTbody.appendChild(tr);
});
}


function autoFormatSummaryCards() {

  const ids = [
    'dbTotalProducts','dbTotalValue','dbExpired','dbShortExpiry',
    'dbReceipts','dbSupplies',

    'totalStockValue','uniqueProductsCount','minStockBatches',

    'rsCount','rsQty','rsValue',

    'plProducts','plBatches','plReceived','plSupplied',
    'plRemaining','plValue',

    'elTrans','elQty','elValue',

    'edTotalEmp','edTotalQty','edTotalValue',

    'pdTotalProducts','pdTotalQty','pdTotalValue'
  ];

  ids.forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;

    let text = el.textContent.replace(/â‚¹|,/g,'').trim();

    // Handle special cases like "0 / â‚¹0"
    if (text.includes('/')) {
      const parts = text.split('/').map(p => p.trim());
      const left = formatIndianNumber(parts[0].replace(/â‚¹|,/g,''), false);
      const right = formatIndianNumber(parts[1].replace(/â‚¹|,/g,''), true);
      el.textContent = left + ' / ' + right;
      return;
    }

    const isCurrency = el.textContent.includes('â‚¹');

    el.textContent = formatIndianNumber(text, isCurrency);
  });

}




</script>




<!-- Employee Distribution Modal -->
<div id="empDistModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50">
  <div class="bg-white w-[95%] max-w-6xl rounded-xl shadow-2xl p-6 relative animate-fadeIn">

    <button onclick="closeEmpDistModal()" 
      class="absolute top-3 right-3 text-slate-500 hover:text-red-600 text-xl font-bold">
      âœ•
    </button>

    <h3 class="text-xl font-bold text-slate-700 mb-4">
      Detailed Distribution
    </h3>

    <div class="overflow-x-auto rounded-lg border shadow-md max-h-[60vh] overflow-y-auto">
      <table id="empDistDetailTable" class="min-w-full text-sm">
        <thead class="table-header-bg border-b">
          <tr>
            <th class="p-3">Date</th>
            <th class="p-3">Emp Code</th>
            <th class="p-3">Emp Name</th>
            <th class="p-3">Designation</th>
            <th class="p-3">Product</th>
            <th class="p-3">Batch</th>
            <th class="p-3">Expiry</th>
            <th class="p-3 text-right">Qty</th>
            <th class="p-3 text-right">Total Value (â‚¹)</th>
            <th class="p-3">Remarks</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Product Distribution Modal -->
<div id="prodDistModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50">
  <div class="bg-white w-[95%] max-w-5xl rounded-xl shadow-2xl p-6 relative">

    <button onclick="closeProdDistModal()" 
      class="absolute top-3 right-3 text-slate-500 hover:text-red-600 text-xl font-bold">
      âœ•
    </button>

    <h3 class="text-xl font-bold text-slate-700 mb-4">
      Product Distribution Details
    </h3>

    <div class="overflow-x-auto rounded-lg border shadow-md max-h-[60vh] overflow-y-auto">
      <table id="prodDistDetailTable" class="min-w-full text-sm">
        <thead class="table-header-bg border-b">
          <tr>
            <th class="p-3">Date</th>
<th class="p-3">Emp Code</th>
  <th class="p-3">Emp Name</th>
            <th class="p-3">Product</th>
            <th class="p-3">Batch</th>
            <th class="p-3">Expiry</th>
            <th class="p-3 text-right">Qty</th>
            <th class="p-3 text-right">Total Value (â‚¹)</th>
            <th class="p-3">Remarks</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100"></tbody>
      </table>
    </div>
  </div>
</div>

</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Delivery Challan | Pristine Pearl Pharma</title>
  <link rel="icon" type="image/png" href="https://www.pristinepearlpharma.in/images/alt-logo.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; background:#f4f7f9; color:#1f2937; }
    .invoice-preview { 
      background:#fff; 
      padding:40px; 
      border-radius:12px; 
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      position: relative;
      z-index: 1;
      max-width: 1000px;
      margin: 0 auto;
    }
    
    .invoice-preview::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background-image: url('https://pristinepearl.com/wp-content/uploads/2020/11/Pristine-Pearl-Pharma-Logo-1.svg');
      background-repeat: no-repeat;
      background-position: center center;
      background-size: 300px;
      opacity: 0.08;
      pointer-events: none;
      z-index: -1;
      transform: rotate(-5deg);
    }

    .accent-bg { background-color: #059669; color: #ffffff; }
    .accent-text { color: #059669; }
    
    @media print {
      body { background:#fff; margin: 0; }
      .no-print { display:none !important; }
      .invoice-preview { box-shadow:none; padding: 0; } 
      .invoice-preview::before { content: none; }
    }
    
    .gst-select {
        appearance: none;
        background-color: #f9fafb;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        padding: 2px 4px;
        font-size: 11px;
        cursor: pointer;
    }
    .gst-select:focus { border-color: #059669; outline: none; }
  </style>
</head>
<body class="bg-gray-50 text-slate-900">

<header class="bg-white border-b border-gray-200 px-4 py-3 no-print">
  <div class="max-w-7xl mx-auto flex items-center justify-between">
    <div class="flex items-center gap-3">
      <img src="https://pristinepearl.com/wp-content/uploads/2020/11/Pristine-Pearl-Pharma-Logo-1.svg" alt="Logo" class="w-16 h-16 object-contain">
      <div>
        <div class="text-lg font-semibold">Inventory Management</div>
        <div class="text-xs text-slate-500">Pristine Pearl Pharma</div>
      </div>
    </div>
    <nav class="flex items-center gap-4">
      <button onclick="window.location.href='DC.html'" class="text-emerald-600 font-semibold border-b-2 border-emerald-600">DC & Tax Invoice</button>
      <button onclick="window.location.href='index.html'" class="hover:text-emerald-600 font-medium">Exit</button>
    </nav>
  </div>
</header>

<main class="p-4 md:p-6">
  <div class="max-w-7xl mx-auto space-y-4 no-print">
    <div class="bg-white border border-gray-200 rounded-lg p-5 shadow-sm">
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <div class="space-y-2">
          <label class="block text-xs font-bold uppercase text-gray-500">1. Select Supply ID</label>
          <div class="flex gap-2">
            <select id="supplyIdSelect" class="flex-1 border rounded-md px-3 py-2 text-sm focus:ring-emerald-500" onchange="onSupplySelect()">
              <option value="">Loading...</option>
            </select>
          </div>
        </div>

        <div class="space-y-2">
          <label class="block text-xs font-bold uppercase text-gray-500">2. Tax Configuration</label>
          <select id="taxTypeSelect" class="w-full border rounded-md px-3 py-2 text-sm focus:ring-emerald-500" onchange="handleTaxTypeChange()">
            <option value="INTRA">Intrastate (CGST + SGST)</option>
            <option value="INTER">Interstate (IGST)</option>
          </select>
        </div>

        <div class="space-y-2 lg:col-span-2">
          <label class="block text-xs font-bold uppercase text-gray-500">3. Transport Details</label>
          <div class="grid grid-cols-2 gap-2">
            <select id="modeOfTransportSelect" class="border rounded-md px-3 py-2 text-sm" onchange="handleTransportChange()">
                <option value="Road (Lorry)">Road (Lorry)</option>
                <option value="Self-Pickup">Self-Pickup</option>
                <option value="Courier">Courier</option>
                <option value="Air Freight">Air Freight</option>
            </select>
            <input type="text" id="vehicleNoInput" class="border rounded-md px-3 py-2 text-sm" placeholder="Vehicle No" oninput="handleTransportChange()">
          </div>
        </div>
      </div>

      <div class="mt-4 flex justify-end gap-3 border-t pt-4">
        <button id="printSupplyBtn" onclick="printInvoiceSameTab()" class="hidden px-6 py-2 rounded-md bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-bold transition-all shadow-md">
            Print Document
        </button>
      </div>
    </div>
  </div>

  <div id="supplyPreviewArea" class="mt-6"></div>
</main>

<div id="eWayBillModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm no-print">
  <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-sm">
    <div class="flex items-center space-x-3 mb-4 text-yellow-600">
      <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
      <h3 class="text-xl font-bold">E-Way Bill Alert</h3>
    </div>
    <p class="text-gray-600 mb-6">Invoice value exceeds ₹50,000. Please ensure an E-Way Bill is generated.</p>
    <button onclick="showEWayBillPopup(false)" class="w-full bg-emerald-600 text-white py-2 rounded font-bold">Acknowledge</button>
  </div>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzMDxxpb7Q2gCwUl0nDgo8iMBMfHJTx-YGK93eYugjncbknWHSc3EfzxyPE6y-a-xW2/exec";

let employees = [], supplyData = [], lastSelectedSupply = null;
let __state = {
  taxType: 'INTRA',
  mode: 'Road (Lorry)',
  vehicleNo: 'N/A',
  itemGst: {}
};

async function post(action, payload={}) {
  try {
    const res = await fetch(WEB_APP_URL, {
      method: 'POST',
      body: JSON.stringify({...payload, action})
    });
    return await res.json();
  } catch (e) { return { success: false, error: e.message }; }
}

document.addEventListener('DOMContentLoaded', async () => {
  const rEmp = await post('getEmployeeList'); if(rEmp.success) employees = rEmp.employees;
  const rSup = await post('getSupplyReport');
  if(rSup.success) {
    supplyData = rSup.rows;
    const ids = [...new Set(supplyData.map(x => x.supplyId))];
    const sel = document.getElementById('supplyIdSelect');
    if (sel) {
      sel.innerHTML = `<option value="">-- Select Supply --</option>` + ids.map(id => `<option>${id}</option>`).join('');
    }
  }
});

function handleTaxTypeChange() {
  const sel = document.getElementById('taxTypeSelect');
  if (sel) __state.taxType = sel.value;
  reRender();
}

function handleTransportChange() {
  const modeSel = document.getElementById('modeOfTransportSelect');
  const vehInput = document.getElementById('vehicleNoInput');
  if (modeSel) __state.mode = modeSel.value;
  if (vehInput) __state.vehicleNo = vehInput.value || 'N/A';
  reRender();
}

function updateItemGst(index, rate) {
  __state.itemGst[index] = Number(rate);
  reRender();
}

function onSupplySelect() {
  const id = document.getElementById('supplyIdSelect').value;
  if(!id) {
    document.getElementById('supplyPreviewArea').innerHTML = '';
    document.getElementById('printSupplyBtn').classList.add('hidden');
    return;
  }
  const rows = supplyData.filter(x => x.supplyId == id);
  const emp = employees.find(e => e['Employee Code'] == rows[0].empCode) || {};
  __state.itemGst = {};
  rows.forEach((_, i) => __state.itemGst[i] = 12);
  lastSelectedSupply = { id, emp, rows };
  document.getElementById('printSupplyBtn').classList.remove('hidden');
  reRender();
}

function reRender() {
  if(!lastSelectedSupply) return;
  const area = document.getElementById('supplyPreviewArea');
  if (area) area.innerHTML = buildHtml(lastSelectedSupply.id, lastSelectedSupply.emp, lastSelectedSupply.rows);
}

function to2(v) { return (Number(v) || 0).toFixed(2); }
function escapeHtml(s) { return String(s || '').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

function buildHtml(id, emp, rows, isPrint = false) {
  let subtotal = 0;
  let totalGst = 0;
  let taxBreakdown = {};
  
  const itemRows = rows.map((r, i) => {
    const qty = Number(r.qty) || 0;
    const mrp = Number(r.mrp) || 0;
    const rate = __state.itemGst[i] || 0;
    const taxableVal = qty * mrp;
    const gstVal = taxableVal * (rate / 100);
    subtotal += taxableVal;
    totalGst += gstVal;

    if(!taxBreakdown[rate]) taxBreakdown[rate] = { taxable: 0, gst: 0 };
    taxBreakdown[rate].taxable += taxableVal;
    taxBreakdown[rate].gst += gstVal;

    const gstControl = isPrint ? `${rate}%` : `
        <select class="gst-select no-print" onchange="updateItemGst(${i}, this.value)">
            <option value="0" ${rate==0?'selected':''}>0%</option>
            <option value="5" ${rate==5?'selected':''}>5%</option>
            <option value="12" ${rate==12?'selected':''}>12%</option>
            <option value="18" ${rate==18?'selected':''}>18%</option>
            <option value="28" ${rate==28?'selected':''}>28%</option>
        </select>
        <span class="hidden print:inline">${rate}%</span>
    `;

    return `
      <tr class="border-b border-gray-100 text-xs">
        <td class="p-2 text-center">${i+1}</td>
        <td class="p-2 font-medium">${escapeHtml(r.item)}</td>
        <td class="p-2 text-center">${escapeHtml(r.batch || 'N/A')}</td>
        <td class="p-2 text-center">${to2(mrp)}</td>
        <td class="p-2 text-center">${qty}</td>
        <td class="p-2 text-center">${gstControl}</td>
        <td class="p-2 text-right font-semibold">${to2(taxableVal + gstVal)}</td>
      </tr>
    `;
  }).join('');

  const grandTotal = subtotal + totalGst;
  if(!isPrint) showEWayBillPopup(grandTotal >= 50000);

  const taxRows = Object.keys(taxBreakdown).sort((a,b)=>a-b).map(rate => {
    const data = taxBreakdown[rate];
    const isInter = __state.taxType === 'INTER';
    return `
      <tr class="text-[10px] border-b">
        <td class="p-1">${rate}%</td>
        <td class="p-1 text-right">${to2(data.taxable)}</td>
        ${isInter ? `<td class="p-1 text-right">${to2(data.gst)}</td>` : `
            <td class="p-1 text-right">${to2(data.gst/2)}</td>
            <td class="p-1 text-right">${to2(data.gst/2)}</td>
        `}
        <td class="p-1 text-right font-bold">${to2(data.gst)}</td>
      </tr>
    `;
  }).join('');

  return `
    <div class="invoice-preview ${isPrint ? 'print-mode' : ''}">
      <div class="flex justify-between items-start border-b-2 border-emerald-600 pb-4 mb-6">
        <div>
          <h2 class="text-2xl font-black accent-text uppercase">Pristine Pearl Pharma Pvt Ltd</h2>
          <p class="text-[10px] text-gray-600 leading-tight">
            Second Floor - 2B, Door No: 129, Thottasalai East, Power House Road,<br>
            Perur Village, Coimbatore - 641010 | GSTIN: 33AAGCB2183C1Z6
            +91 99945 35136 | samples.pearl@gmail.com
          </p>
        </div>
        <div class="text-right">
          <h1 class="text-xl font-bold text-gray-800">DELIVERY CHALLAN</h1>
          <p class="text-sm font-bold text-emerald-700">#${id}</p>
          <p class="text-xs text-gray-500">${new Date().toLocaleDateString('en-GB')}</p>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4 mb-6 text-xs">
        <div class="bg-gray-50 p-3 rounded">
          <p class="font-bold text-gray-500 uppercase mb-1">Consignee:</p>
          <p class="font-bold text-base">${escapeHtml(emp['Employee Name'] || 'Client')}</p>
          <p>${escapeHtml(emp['Address'] || '')}</p>
          <p>${escapeHtml(emp['City'] || '')} - ${escapeHtml(emp['Pincode'] || '')}</p>
          <p>Mob: ${escapeHtml(emp['MobileNo'] || '')}</p>
        </div>
        <div class="border border-dashed border-gray-300 p-3 rounded space-y-1">
          <p class="font-bold text-gray-500 uppercase mb-1">Shipping Details:</p>
          <div class="flex justify-between"><span>Mode:</span><span class="font-bold">${__state.mode}</span></div>
          <div class="flex justify-between"><span>Vehicle:</span><span class="font-bold">${__state.vehicleNo}</span></div>
        </div>
      </div>

      <table class="w-full mb-6">
        <thead class="accent-bg text-[10px] uppercase">
          <tr>
            <th class="p-2">Sl</th><th class="p-2 text-left">Description</th><th class="p-2">Batch</th><th class="p-2">Rate</th><th class="p-2">Qty</th><th class="p-2">GST %</th><th class="p-2 text-right">Total (Incl)</th>
          </tr>
        </thead>
        <tbody>${itemRows}</tbody>
      </table>

      <div class="flex flex-wrap lg:flex-nowrap justify-between gap-8 mt-4">
        <div class="w-full lg:w-3/5">
          <p class="text-[10px] font-bold text-gray-500 uppercase mb-1">Tax Breakdown:</p>
          <table class="w-full border text-left bg-gray-50">
            <thead class="bg-gray-200 text-[9px] uppercase">
              <tr>
                <th class="p-1">Rate</th><th class="p-1 text-right">Taxable</th>
                ${__state.taxType === 'INTER' ? `<th class="p-1 text-right">IGST</th>` : `<th class="p-1 text-right">CGST</th><th class="p-1 text-right">SGST</th>`}
                <th class="p-1 text-right">Total Tax</th>
              </tr>
            </thead>
            <tbody>${taxRows}</tbody>
          </table>
        </div>
        <div class="w-full lg:w-1/3 space-y-2">
            <div class="flex justify-between text-sm"><span>Sub-Total (Taxable):</span><span>₹${to2(subtotal)}</span></div>
            <div class="flex justify-between text-sm"><span>Total GST:</span><span>₹${to2(totalGst)}</span></div>
            <div class="flex justify-between text-lg font-black accent-text border-t-2 pt-2"><span>GRAND TOTAL:</span><span>₹${to2(grandTotal)}</span></div>
        </div>
      </div>

      <div class="mt-10 flex justify-between items-end border-t pt-8">
        <div class="text-[9px] text-gray-500 max-w-xs">
          <p class="font-bold text-gray-800">Declaration:</p>
          <p>This is a delivery challan for sample/demo purposes.</p>
        </div>
        <div class="text-center">
            <div class="w-40 border-t border-gray-400 mx-auto mb-1"></div>
            <p class="text-xs font-bold uppercase">Authorised Signatory</p>
            <p class="text-[9px] text-gray-500">Pristine Pearl Pharma Pvt Ltd</p>
        </div>
      </div>
    </div>
  `;
}

function showEWayBillPopup(show) {
  const m = document.getElementById('eWayBillModal');
  if (m) {
    m.classList.toggle('hidden', !show);
    m.classList.toggle('flex', show);
  }
}

function printInvoiceSameTab() {
  if (!lastSelectedSupply) return;
  const content = buildHtml(lastSelectedSupply.id, lastSelectedSupply.emp, lastSelectedSupply.rows, true);
  const win = window.open('', '_blank');
  win.document.write('<html><head><title>Print DC - ' + lastSelectedSupply.id + '</title>');
  win.document.write('<script src="https://cdn.tailwindcss.com"></scr' + 'ipt>');
  win.document.write('<style>@import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap");body{font-family:"Inter",sans-serif;padding:20px;}.accent-text{color:#059669;}.accent-bg{background-color:#059669;color:white;-webkit-print-color-adjust:exact;}@media print{.no-print{display:none;}}</style></head><body>');
  win.document.write(content);
  win.document.write('</body></html>');
  win.document.close();
  setTimeout(function() { win.print(); }, 500);
}
</script>
</body>
</html>

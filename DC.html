<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Delivery Challan </title>
  <link rel="icon" type="image/png" href="https://www.pristinepearlpharma.in/images/alt-logo.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    /* Updated styles for modern look */
    body { font-family: 'Inter', sans-serif; background:#f4f7f9; color:#1f2937; }
    .invoice-preview { 
      background:#fff; 
      border:none; /* Removing outer border for cleaner look */
      padding:40px; 
      border-radius:12px; 
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* Soft shadow */
      position: relative; /* Added for watermark positioning */
      z-index: 1; /* Ensure content stacks above the watermark */
    }
    
    /* Watermark Style for On-Screen Preview (uses CSS pseudo-element) */
    .invoice-preview::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: url('https://pristinepearl.com/wp-content/uploads/2020/11/Pristine-Pearl-Pharma-Logo-1.svg');
      background-repeat: no-repeat;
      background-position: center center;
      background-size: 300px; /* Size of the watermark */
      opacity: 0.10; /* Very subtle transparency */
      pointer-events: none; /* Allows clicks/selection through the watermark */
      z-index: -1; /* Place behind the content */
      transform: rotate(-5deg); /* Slight rotation for effect */
    }

    .accent-bg { background-color: #059669; color: #ffffff; } /* Emerald-600 */
    .accent-text { color: #059669; }
    
    @media print {
      body { background:#fff; }
      .no-print { display:none !important; }
      /* Remove box shadow and padding for clean print */
      .invoice-preview { border:none; box-shadow:none; padding: 0; } 
      
      /* Disable the pseudo-element watermark in print since we use an HTML element in getPrintPreview for better control */
      .invoice-preview::before { content: none; }
    }
    
    /* Print styles for printInvoiceSameTab function to use */
    .print-invoice-body {
      font-family: 'Inter', sans-serif; 
      font-size: 10pt; 
      padding: 0; 
      color: #1f2937;
    }
    .print-invoice-table {
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 15px; 
    }
    .print-invoice-table th, .print-invoice-table td {
      border: 1px solid #e5e7eb; 
      padding: 6px 8px;
    }
    .print-invoice-table th {
      background-color: #f3f4f6; 
      font-weight: 600;
      color: #1f2937;
    }
    .print-invoice-table tfoot td {
        background-color: #f3f4f6; 
        font-weight: 700;
    }
    @page {
      size: A4; 
      margin: 10mm;
    }
  </style>
</head>
<body class="bg-gray-50 text-slate-900">

<!-- HEADER -->
<header class="bg-white border-b border-gray-200 px-4 py-3 no-print">
  <div class="max-w-7xl mx-auto flex items-center justify-between">
    <div class="flex items-center gap-3">
      <!-- Logo in the navigation bar -->
      <img src="https://pristinepearl.com/wp-content/uploads/2020/11/Pristine-Pearl-Pharma-Logo-1.svg" alt="Pristine Pearl Pharma Logo" class="w-20 h-20 object-contain rounded-lg" onerror="this.onerror=null;this.src='https://placehold.co/40x40/059669/ffffff?text=PP'">
      <div>
        <div class="text-lg font-semibold">Inventory Management</div>
        <div class="text-xs text-slate-500">Pristine Pearl Pharma</div>
      </div>
    </div>
    <nav class="flex items-center gap-3">
      <button onclick="window.location.href='Invoice.html'" class="hover:text-emerald-600 font-medium">Back</button>
    </nav>
  </div>
</header>

<main class="p-4 md:p-6">
  <div class="max-w-7xl mx-auto bg-white border border-gray-200 rounded-lg p-4 shadow-sm no-print">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div>
        <h2 class="text-lg font-semibold">Delivery Challan</h2>
        <p class="text-sm text-slate-500">Select a saved Supply ID and configure transport details below.</p>
      </div>
      <div class="flex items-center gap-2">
        <label class="text-sm">Supply ID</label>
        <select id="supplyIdSelect" class="border rounded-md px-2 py-1 text-sm focus:ring-emerald-500 focus:border-emerald-500" onchange="onSupplySelect()">
          <option value="">Loading...</option>
        </select>
        <button id="printSupplyBtn" onclick="printInvoiceSameTab()" class="hidden px-4 py-2 rounded-md bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-medium transition-colors duration-150">Print DC</button>
      </div>
    </div>
    
    <!-- START: INTERACTIVE TRANSPORT INPUTS -->
    <div class="mt-4 p-4 border border-gray-200 rounded-lg bg-gray-50 grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
            <label for="modeOfTransportSelect" class="block text-xs font-semibold uppercase text-gray-700 mb-1">Mode of Transport</label>
            <select id="modeOfTransportSelect" class="w-full border rounded-md px-2 py-1.5 text-sm focus:ring-emerald-500 focus:border-emerald-500" onchange="handleTransportChange()">
                <option value="Road (Lorry)">Road (Lorry)</option>
                <option value="Self-Pickup">Self-Pickup</option>
                <option value="Courier/Parcel">Courier/Parcel</option>
                <option value="Air Freight">Air Freight</option>
            </select>
        </div>
        <div>
            <label for="vehicleNoInput" class="block text-xs font-semibold uppercase text-gray-700 mb-1">Vehicle No</label>
            <input type="text" id="vehicleNoInput" class="w-full border rounded-md px-2 py-1.5 text-sm focus:ring-emerald-500 focus:border-emerald-500" placeholder="Enter Vehicle No or N/A" oninput="handleTransportChange()">
        </div>
        <div class="md:col-span-1">
            <label class="block text-xs font-semibold uppercase text-gray-700 mb-1">Transport Details (Auto-Derived)</label>
            <div id="transportDetailsAuto" class="text-xs italic text-gray-600 p-2 border border-gray-300 rounded-md h-full bg-white"></div>
        </div>
    </div>
    <!-- END: INTERACTIVE TRANSPORT INPUTS -->

    <!-- This area uses the new modernized style -->
    <div id="supplyPreviewArea" class="mt-5"></div>
  </div>
</main>

<!-- Loading Spinner -->
<div id="loading" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/25 no-print">
  <div class="w-16 h-16 rounded-full border-8 border-white/25 border-t-white animate-spin"></div>
</div>

<!-- E-Way Bill Warning Modal (New Feature) -->
<div id="eWayBillModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm">
  <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-sm transform transition-all duration-300 scale-100">
    <div class="flex items-center space-x-3 mb-4 border-b pb-3 border-yellow-200">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-8 h-8 text-yellow-500">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.375c-.832 1.266-.832 2.845 0 4.111.776 1.173 1.954 1.849 3.177 1.849h1.968a5.5 5.5 0 005.5-5.5v-1.968a5.5 5.5 0 00-5.5-5.5H5.875C4.652 4.125 3.474 4.79 2.7 6.012c-.832 1.266-.832 2.845 0 4.111.776 1.173 1.954 1.849 3.177 1.849h1.968a5.5 5.5 0 005.5-5.5v-1.968a5.5 5.5 0 00-5.5-5.5H5.875zM12 18h.01" />
      </svg>
      <h3 class="text-xl font-bold text-gray-800">Compliance Alert</h3>
    </div>
    <p class="text-gray-600 mb-6 font-medium text-lg">E-Way Bill Necessary</p>
    <div class="text-sm text-gray-500 mb-6">The total invoice value is over ₹50,000. Please ensure the required **E-Way Bill is generated** for transportation of these goods.</div>
    <button onclick="showEWayBillPopup(false)" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 rounded-md transition-colors duration-150">Acknowledge</button>
  </div>
</div>


<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzMDxxpb7Q2gCwUl0nDgo8iMBMfHJTx-YGK93eYugjncbknWHSc3EfzxyPE6y-a-xW2/exec";
const E_WAY_BILL_LIMIT = 50000; // Constant for the E-Way Bill threshold

// Map for auto-deriving transport details based on mode
const TRANSPORT_MODES_MAP = {
  "Road (Lorry)": "Shipment dispatched via third-party road carrier.",
  "Self-Pickup": "Goods picked up directly by the consignee or their authorized agent.",
  "Courier/Parcel": "Parcel shipment handled by a third-party courier service.",
  "Air Freight": "Shipment dispatched via air transportation."
};

let employees = [], lastSelectedSupply=null;

// Global state for transport details
let __transportState = {
  mode: 'Road (Lorry)',
  vehicleNo: 'N/A',
  details: TRANSPORT_MODES_MAP["Road (Lorry)"]
};

function showLoading(){document.getElementById('loading').style.display='flex'}
function hideLoading(){document.getElementById('loading').style.display='none'}

/**
 * Shows or hides the E-Way Bill compliance modal.
 * @param {boolean} show - True to show the modal, false to hide it.
 */
function showEWayBillPopup(show) {
    const modal = document.getElementById('eWayBillModal');
    if (modal) {
        if (show) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        } else {
            modal.classList.remove('flex');
            modal.classList.add('hidden');
        }
    }
}


async function post(action,payload={}) {
  showLoading();
  // Implementing exponential backoff for robust API calls
  const maxRetries = 5;
  let delay = 1000;
  
  for (let i = 0; i < maxRetries; i++) {
      try {
          const res = await fetch(WEB_APP_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'text/plain;charset=utf-8' },
              body: JSON.stringify({...payload, action})
          });

          if (res.ok) {
              const json = await res.json();
              hideLoading();
              return json;
          } else if (res.status === 429 || res.status >= 500) {
              // Throttle or server error, attempt retry
              if (i < maxRetries - 1) {
                  await new Promise(resolve => setTimeout(resolve, delay));
                  delay *= 2; // Exponential backoff
                  continue; // Retry the loop
              }
          }
          
          // Non-retryable error
          throw new Error(`API returned status ${res.status}`);

      } catch (e) {
          console.error(`Attempt ${i + 1} failed:`, e);
          if (i < maxRetries - 1) {
              await new Promise(resolve => setTimeout(resolve, delay));
              delay *= 2; // Exponential backoff
          } else {
              hideLoading();
              return { success: false, error: e.message };
          }
      }
  }
}


document.addEventListener('DOMContentLoaded',async()=>{
  await loadEmployees(); 
  await loadSupplyList();
  // Initialize transport inputs and details display on load
  initTransportInputs(); 
});

function initTransportInputs() {
    // Set initial/default state on UI elements
    document.getElementById('modeOfTransportSelect').value = __transportState.mode;
    document.getElementById('vehicleNoInput').value = __transportState.vehicleNo;
    document.getElementById('transportDetailsAuto').textContent = __transportState.details;
}

function handleTransportChange() {
    const modeSelect = document.getElementById('modeOfTransportSelect');
    const vehicleInput = document.getElementById('vehicleNoInput');
    const detailsDiv = document.getElementById('transportDetailsAuto');

    const newMode = modeSelect.value;
    const newVehicleNo = vehicleInput.value.trim() || 'N/A';
    const newDetails = TRANSPORT_MODES_MAP[newMode] || 'Transport mode details not available.';

    // Update global state
    __transportState.mode = newMode;
    __transportState.vehicleNo = newVehicleNo;
    __transportState.details = newDetails;
    
    // Update the auto-derived text box in the UI
    detailsDiv.textContent = newDetails;

    // If an invoice is currently loaded, re-render the preview using the new state
    if(lastSelectedSupply) {
        const {supplyId, emp, rows} = lastSelectedSupply;
        document.getElementById('supplyPreviewArea').innerHTML = buildPreview(supplyId, emp, rows);
    }
}

async function loadEmployees(){
  const r=await post('getEmployeeList'); if(r.success) employees=r.employees;
}
async function loadSupplyList(){
  const sel=document.getElementById('supplyIdSelect');
  const r=await post('getSupplyReport');
  if(!r.success){sel.innerHTML=`<option>No supplies</option>`;return;}
  const ids=[...new Set(r.rows.map(x=>x.supplyId))];
  sel.innerHTML=`<option value="">--Select--</option>`+ids.map(i=>`<option>${i}</option>`).join('');
}

/**
 * Converts a date string (ISO, YYYY-MM-DD, or MM/YY) into MM-YY format.
 * Defaults to 'N/A' if the input is invalid or missing.
 * @param {string | null | undefined} dateStr - The input date string.
 * @returns {string} The date formatted as MM-YY or 'N/A'.
 */
function formatExpiryDate(dateStr) {
    if (!dateStr) return 'N/A';
    
    const str = String(dateStr);

    // 1. Check if it's a full date string (like ISO or YYYY-MM-DD)
    if (str.includes('-') && str.includes('T')) {
        // Use Date object for robust parsing of ISO strings
        const date = new Date(str);
        // Check if the date is valid
        if (isNaN(date.getTime())) return 'N/A';

        // Get month (0-indexed) and year
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = String(date.getFullYear()).slice(-2);
        return `${month}-${year}`; // e.g., 05-25
    }
    
    // 2. Check if it's already YYYY-MM-DD format (without time)
    if (str.match(/^\d{4}-\d{2}-\d{2}$/)) {
        const parts = str.split('-');
        const month = parts[1];
        const year = parts[0].slice(-2);
        return `${month}-${year}`;
    }

    // 3. Fallback: If it's already a short format (MM/YY or MM-YY), just ensure it uses '-'
    return str.replace('/', '-');
}


async function onSupplySelect(){
  const id=document.getElementById('supplyIdSelect').value;
  const area=document.getElementById('supplyPreviewArea');
  if(!id){
    area.innerHTML='';
    document.getElementById('printSupplyBtn').classList.add('hidden');
    showEWayBillPopup(false); // Ensure popup is hidden if selection is cleared
    return;
  }
  
  const r=await post('getSupplyReport'); if(!r.success)return;
  const rows=r.rows.filter(x=>x.supplyId==id); 
  
  // TEMPORARILY MOCK BATCH AND EXPIRY DATA IF IT'S NOT PRESENT IN THE ROWS
  // In a real application, this data should come directly from the backend.
  
  const finalRows = rows.map((r, i) => ({
      ...r,
      // Assuming r.batch is available. Mocking if not.
      batch: r.batch || `BCH-${String(i + 1).padStart(3, '0')}`,
      // Use the new formatting function to ensure MM-YY format
      expiry: formatExpiryDate(r.expiry),
  }));
  // END MOCKING LOGIC
  
  if(!finalRows.length)return;
  const emp=employees.find(e=>e['Employee Code']==finalRows[0].empCode)||{};
  
  // Calculate total amount for E-Way Bill check
  let totalAmount = 0;
  finalRows.forEach(r => {
    const qty = Number(r.qty) || 0;
    const mrp = Number(r.mrp) || 0;
    totalAmount += qty * mrp;
  });

  // RENDER PREVIEW using the live __transportState and finalRows
  area.innerHTML=buildPreview(id,emp,finalRows);
  lastSelectedSupply={supplyId:id,emp,rows:finalRows}; // Use finalRows for lastSelectedSupply
  document.getElementById('printSupplyBtn').classList.remove('hidden');
  
  // Check for E-Way Bill requirement: totalAmount must be >= ₹50,000 (higher than 49,999)
  if (totalAmount >= E_WAY_BILL_LIMIT) {
    showEWayBillPopup(true);
  } else {
    showEWayBillPopup(false);
  }
}

function escapeHtml(s){return String(s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]))}
function to2(v){return (Number(v)||0).toFixed(2);}
function numberToWords(n){const o=["","One","Two","Three","Four","Five","Six","Seven","Eight","Nine","Ten","Eleven","Twelve","Thirteen","Fourteen","Fifteen","Sixteen","Seventeen","Eighteen","Nineteen"],t=["","","Twenty","Thirty","Forty","Fifty","Sixty","Seventy","Eighty","Ninety"];function f(x){return x<20?o[x]:t[Math.floor(x/10)]+(x%10?" "+o[x%10]:"")}function h(x){return x>99?o[Math.floor(x/100)]+" Hundred "+f(x%100):f(x)}let w="",c=Math.floor(n/1e7),l=Math.floor(n/1e5)%100,tTh=Math.floor(n/1e3)%1000,hun=n%1e3;if(c)w+=h(c)+" Crore ";if(l)w+=h(l)+" Lakh ";if(tTh)w+=h(tTh)+" Thousand ";if(hun)w+=h(hun);return w.trim()||"Zero"}

// --- MODERNIZED INVOICE PREVIEW FUNCTION ---
function buildPreview(id,emp,rows){
  const name=emp['Employee Name']||rows[0].empName||'';
  const code=emp['Employee Code']||rows[0].empCode||'';
  const addr=emp['Address']||''; const city=emp['City']||''; const pin=emp['Pincode']||'';
  const mob=emp['MobileNo']||''; const mail=emp['New Mail Id']||'';
  const date=new Date().toLocaleDateString('en-GB');
  let tot=0; let itemRows='';

  // --- START: USE LIVE TRANSPORT DATA FROM STATE ---
  const transportDetails = __transportState.details;
  const modeOfTransport = __transportState.mode;
  const vehicleNo = __transportState.vehicleNo;
  // --- END: USE LIVE TRANSPORT DATA FROM STATE ---
  
  rows.forEach((r,i)=>{
    const qty = Number(r.qty) || 0;
    const mrp = Number(r.mrp) || 0;
    const amt = qty * mrp;
    tot+=amt;
    itemRows+=`
    <tr class="text-gray-700 hover:bg-gray-50 transition-colors duration-75">
      <td class="p-2 text-center border-b border-gray-200">${i+1}</td>
      <td class="p-2 border-b border-gray-200">${escapeHtml(r.item||'')}</td>
      <td class="p-2 text-center border-b border-gray-200 text-xs">${escapeHtml(r.batch||'N/A')}</td>
      <td class="p-2 text-center border-b border-gray-200 text-xs">${escapeHtml(r.expiry||'N/A')}</td>
      <td class="p-2 text-right border-b border-gray-200">${to2(mrp)}</td>
      <td class="p-2 text-right border-b border-gray-200">${qty}</td>
      <td class="p-2 text-right border-b border-gray-200 font-medium">${to2(amt)}</td>
    </tr>`});
  const words=numberToWords(Math.round(tot))+" Only";

  // Re-engineered HTML structure for a modern look
  return `
  <div class="invoice-preview text-sm leading-normal">
    
    <!-- Header Section (Company & Invoice Details) -->
    <!-- Removed items-start, added items-center. The watermark is now applied via the ::before pseudo-element on .invoice-preview -->
    <div class="flex justify-between items-center mb-6 pb-4 border-b border-gray-200">
      
      <!-- Company Info (Logo removed from here) -->
      <div>
          <div>
            <!-- Company Header Details Applied -->
            <div class="text-xl font-bold accent-text">PRISTINE PEARL PHARMA PVT LTD</div>
            <div class="text-xs text-gray-600 mt-0.5">Second Floor - 2B, Door No: 129, Thottasalai East, Power House Road,</div>
            <div class="text-xs text-gray-600">Perur Village, Coimbatore - 641010</div>
            <div class="text-xs text-gray-600">GSTIN/UIN: 33AAGCB2183C1Z6 | DL NO - TN-10-20B-00354, TN-10-21B-00354</div>
            <!-- End Company Header Details -->
          </div>
      </div>

      <!-- Invoice Metadata -->
      <div class="text-right">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-2">DELVERY CHALLAN</h1>
        <div class="space-y-1">
          <div class="text-sm"><span class="font-semibold text-gray-600">DC No:</span> <span class="font-bold accent-text">${escapeHtml(id)}</span></div>
          <div class="text-sm"><span class="font-semibold text-gray-600">Date:</span> ${escapeHtml(date)}</div>
          <div class="text-sm"><span class="font-semibold text-gray-600">Reference:</span> DC-ID-${escapeHtml(id)}</div>
        </div>
      </div>
    </div>

    <!-- Client / Consignee Details -->
    <div class="flex justify-between gap-6 mb-4 p-4 bg-gray-50 border border-gray-200 rounded-lg">
      <div>
        <div class="text-xs font-semibold uppercase text-gray-500 mb-1">Bill/Ship To:</div>
        <div class="font-semibold text-gray-800">${escapeHtml(name)} (${escapeHtml(code)})</div>
        <div class="text-gray-600">${escapeHtml(addr)}</div>
        <div class="text-gray-600">${escapeHtml(city)} - ${escapeHtml(pin)}</div>
      </div>
      <div class="text-right">
        <div class="text-xs font-semibold uppercase text-gray-500 mb-1">Contact:</div>
        <div class="text-gray-600">Mobile: ${escapeHtml(mob)}</div>
        <div class="text-gray-600">Email: ${escapeHtml(mail)}</div>
      </div>
    </div>

    <!-- START: TRANSPORT DETAILS SECTION -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 p-3 bg-white border border-dashed border-gray-300 rounded-lg">
        <div>
            <div class="text-xs font-semibold uppercase text-gray-500 mb-0.5">Mode of transport:</div>
            <div class="text-gray-800 font-medium">${escapeHtml(modeOfTransport)}</div>
        </div>
        <div>
            <div class="text-xs font-semibold uppercase text-gray-500 mb-0.5">Vehicle No:</div>
            <div class="text-gray-800 font-medium">${escapeHtml(vehicleNo)}</div>
        </div>
        <div class="md:col-span-1">
            <div class="text-xs font-semibold uppercase text-gray-500 mb-0.5">Transport Details:</div>
            <div class="text-gray-800 text-xs italic">${escapeHtml(transportDetails)}</div>
        </div>
    </div>
    <!-- END: TRANSPORT DETAILS SECTION -->


    <!-- Items Table -->
    <table class="w-full text-left">
      <thead class="accent-bg text-white">
        <tr>
          <th class="p-2 w-10 text-center rounded-tl-lg">Sl</th>
          <th class="p-2">Description of Goods</th>
          <th class="p-2 w-20 text-center">Batch No.</th>
          <th class="p-2 w-20 text-center">Expiry Date</th>
          <th class="p-2 w-20 text-right">Rate (₹)</th>
          <th class="p-2 w-16 text-right">Qty</th>
          <th class="p-2 w-28 text-right rounded-tr-lg">Amount (₹)</th>
        </tr>
      </thead>
      <tbody>${itemRows}</tbody>
    </table>

    <!-- Totals & Summary Section -->
    <div class="flex justify-end mt-6">
      <div class="w-full max-w-sm">
        <!-- Subtotal / Grand Total Box -->
        <div class="p-4 border border-gray-300 rounded-lg bg-gray-50">
          <div class="flex justify-between py-1 text-gray-700">
            <div>Sub Total:</div>
            <div class="font-medium">${to2(tot)}</div>
          </div>
          
          <div class="flex justify-between py-2 mt-2 pt-3 border-t-2 border-emerald-500/50 font-extrabold text-lg accent-text">
            <div>TOTAL AMOUNT:</div>
            <div>₹ ${to2(tot)}</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Amount in Words & Declaration -->
    <div class="mt-6">
      <div class="text-xs font-semibold uppercase text-gray-500 mb-1">Amount Chargeable (in words):</div>
      <div class="p-2 border border-gray-300 bg-white font-medium text-gray-800 rounded-md">${escapeHtml(words)}</div>
    </div>

    <div class="mt-8 flex justify-between items-end">
      <!-- Declaration & Footer Left -->
      <div class="w-1/2 text-xs text-gray-600 pr-4">
        <div class="font-bold text-gray-800 mb-1">Note:</div>
        <div>1. Not for Sale, Only for Sample Purpose.<br>
2. Goods sent for sample purpose (No sale involved. No GST applicable.)</div>
        <div class="mt-3 text-[10px] text-gray-500">
          Created by: <a href="mailto:samples.pearl@gmail.com" class="hover:underline">samples.pearl@gmail.com</a><br>
          This is an Auto-Generated Document.
        </div>
      </div>

      <!-- Signature Block -->
      <div class="text-center">
        <div class="border-t border-gray-400 w-48 mb-1"></div>
        <div class="font-semibold text-sm text-gray-800">Authorised Signatory</div>
        <div class="text-xs text-gray-600">for PRISTINE PEARL PHARMA PVT LTD</div>
      </div>
    </div>

  </div>`;
}

function printInvoiceSameTab(){
  // Custom print function uses basic print styles for clean paper output
  if(!lastSelectedSupply) return console.error('Select a Supply ID first');
  
  const {supplyId,emp,rows}=lastSelectedSupply;
  
  // Replicating the modern invoice structure with print-friendly classes
  const getPrintPreview = (id, emp, rows) => {
    const name=emp['Employee Name']||rows[0].empName||'';
    const code=emp['Employee Code']||rows[0].empCode||'';
    const addr=emp['Address']||''; const city=emp['City']||''; const pin=emp['Pincode']||'';
    const mob=emp['MobileNo']||''; const mail=emp['New Mail Id']||'';
    const date=new Date().toLocaleDateString('en-GB');
    let tot=0; let itemRows='';

    // --- START: USE LIVE TRANSPORT DATA FROM STATE (Print) ---
    const transportDetails = __transportState.details;
    const modeOfTransport = __transportState.mode;
    const vehicleNo = __transportState.vehicleNo;
    // --- END: USE LIVE TRANSPORT DATA FROM STATE (Print) ---
    
    rows.forEach((r,i)=>{
      const qty = Number(r.qty) || 0;
      const mrp = Number(r.mrp) || 0;
      const amt = qty * mrp;
      tot+=amt;
      itemRows+=`
      <tr>
        <td style="text-align:center;">${i+1}</td>
        <td>${escapeHtml(r.item||'')}</td>
        <td style="text-align:center; font-size: 8pt;">${escapeHtml(r.batch||'N/A')}</td>
        <td style="text-align:center; font-size: 8pt;">${escapeHtml(r.expiry||'N/A')}</td>
        <td style="text-align:right;">${to2(mrp)}</td>
        <td style="text-align:right;">${qty}</td>
        <td style="text-align:right;">${to2(amt)}</td>
      </tr>`
    });
    const words=numberToWords(Math.round(tot))+" Only";
    
    // Watermark HTML injection and content wrapping
    return `
    <div style="padding: 20px; position: relative; min-height: 280mm;">
        <!-- Watermark Element for Print -->
        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: -1; 
                    display: flex; justify-content: center; align-items: center;">
            <img src="https://pristinepearl.com/wp-content/uploads/2020/11/Pristine-Pearl-Pharma-Logo-1.svg" 
                 alt="Watermark" 
                 style="width: 300px; height: auto; opacity: 0.1;" 
                 onerror="this.style.display='none';">
        </div>
        
        <!-- Wrapper for Z-index above watermark -->
        <div style="position: relative; z-index: 1;"> 
            <!-- Header Section (Logo removed) -->
            <div style="display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid #ccc; padding-bottom: 10px; margin-bottom: 20px;">
                <div>
                    <!-- Logo image removed from header -->
                    <div style="font-size: 16pt; font-weight: bold; color: #059669;">PRISTINE PEARL PHARMA PVT LTD</div>
                    <div style="font-size: 8pt; color: #555;">Second Floor - 2B, Door No: 129, Thottasalai East, Power House Road,</div>
                    <div style="font-size: 8pt; color: #555;">Perur Village, Coimbatore - 641010</div>
<div style="font-size: 8pt; color: #555;">samples.pearl@gmail.com | +91 8838001387</div>
                    <div style="font-size: 8pt; color: #555;">GSTIN/UIN: 33AAGCB2183C1Z6 | DL NO - TN-10-20B-00354, TN-10-21B-00354</div>
                </div>
                <div style="text-align: right;">
                    <h1 style="font-size: 24pt; font-weight: bold; margin: 0; color: #333;">DELIVERY CHALLAN</h1>
                    <div style="font-size: 9pt; margin-top: 5px;">
                        <span style="font-weight: bold; color: #555;">DC No.:</span> <span style="font-weight: bold; color: #059669;">${escapeHtml(id)}</span><br>
                        <span style="font-weight: bold; color: #555;">Date:</span> ${escapeHtml(date)}
                    </div>
                </div>
            </div>

            <!-- Client Details -->
            <div style="display: flex; justify-content: space-between; font-size: 10pt; background-color: #f3f4f6; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 15px;">
                <div>
                    <div style="font-weight: bold; text-transform: uppercase; color: #555; margin-bottom: 3px; font-size: 8pt;">Bill/Ship To:</div>
                    <div style="font-weight: bold;">${escapeHtml(name)} (${escapeHtml(code)})</div>
                    <div>${escapeHtml(addr)}</div>
                    <div>${escapeHtml(city)} - ${escapeHtml(pin)}</div>
                </div>
                <div style="text-align: right;">
                    <div style="font-weight: bold; text-transform: uppercase; color: #555; margin-bottom: 3px; font-size: 8pt;">Contact:</div>
                    <div>Mobile: ${escapeHtml(mob)}</div>
                    <div>Email: ${escapeHtml(mail)}</div>
                </div>
            </div>

            <!-- START: TRANSPORT DETAILS SECTION (Print) -->
            <div style="font-size: 8pt; background-color: #ffffff; border: 1px dashed #ccc; padding: 8px; margin-bottom: 15px; display: flex; justify-content: space-between;">
                <div style="width: 30%;">
                    <div style="font-weight: bold; text-transform: uppercase; color: #555; margin-bottom: 3px; font-size: 7pt;">Mode of transport:</div>
                    <div style="font-weight: 500;">${escapeHtml(modeOfTransport)}</div>
                </div>
                <div style="width: 30%;">
                    <div style="font-weight: bold; text-transform: uppercase; color: #555; margin-bottom: 3px; font-size: 7pt;">Vehicle No:</div>
                    <div style="font-weight: 500;">${escapeHtml(vehicleNo)}</div>
                </div>
                <div style="width: 35%;">
                    <div style="font-weight: bold; text-transform: uppercase; color: #555; margin-bottom: 3px; font-size: 7pt;">Transport Details:</div>
                    <div style="font-style: italic;">${escapeHtml(transportDetails)}</div>
                </div>
            </div>
            <!-- END: TRANSPORT DETAILS SECTION (Print) -->


            <!-- Items Table -->
            <table class="print-invoice-table">
              <thead>
                <tr style="background-color: #059669; color: white;">
                  <th style="width: 5%; text-align:center; border-color: #059669;">Sl</th>
                  <th style="width: auto; border-color: #059669;">Description of Goods</th>
                  <th style="width: 10%; text-align:center; border-color: #059669;">Batch</th>
                  <th style="width: 10%; text-align:center; border-color: #059669;">Expiry</th>
                  <th style="width: 15%; text-align:right; border-color: #059669;">Rate (₹)</th>
                  <th style="width: 10%; text-align:right; border-color: #059669;">Qty</th>
                  <th style="width: 15%; text-align:right; border-color: #059669;">Amount (₹)</th>
                </tr>
              </thead>
              <tbody>${itemRows}</tbody>
              <tfoot>
                <tr>
                  <td colspan="6" style="text-align:right; background-color: #f3f4f6; font-weight: bold;">Total ₹</td>
                  <td style="text-align:right; background-color: #f3f4f6; font-weight: bold; color: #059669; font-size: 12pt;">${to2(tot)}</td>
                </tr>
              </tfoot>
            </table>

            <!-- Amount in Words & Totals Box -->
            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <div style="width: 60%;">
                    <div style="font-weight: bold; font-size: 9pt; text-transform: uppercase; color: #555; margin-bottom: 3px;">Amount Chargeable (in words):</div>
                    <div style="border: 1px solid #ccc; padding: 5px; background-color: #f9f9f9; font-weight: 500;">${escapeHtml(words)}</div>
                </div>
            </div>

            <!-- Declaration and Signature -->
            <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-top: 30px;">
                <div style="width: 50%; font-size: 8pt; color: #666;">
                    <div style="font-weight: bold; color: #333; margin-bottom: 5px;">Note:</div>
                    <div>1. Not for Sale, Only for Sample Purpose.<br>
2. Goods sent for sample purpose (No sale involved. No GST applicable.) </div>
                    <div style="margin-top: 10px; font-size: 7pt; color: #999;">Created By : SAMPLE DEPARTMENT
This is an Auto-Generated Document.</div>
                </div>
                <div style="text-align: center; font-size: 10pt;">
                    <div style="border-top: 1px solid #333; width: 150px; margin-bottom: 5px;"></div>
                    <div style="font-weight: bold;">Authorised Signatory</div>
                    <div style="font-size: 9pt; color: #666;">for PRISTINE PEARL PHARMA PVT LTD</div>
                </div>
            </div>
        </div>
    </div>
    `;
  };

  const printHtml = `<html><head><meta charset='utf-8'><title>Invoice: ${supplyId}</title>
  <style>
    /* Use the same print styles defined in the main document's style block */
    body { font-family: 'Inter', sans-serif; font-size: 10pt; padding: 0; color: #1f2937; margin: 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #e5e7eb; padding: 6px 8px; }
    th { background-color: #f3f4f6; font-weight: 600; color: #1f2937; }
    tfoot td { background-color: #f3f4f6; font-weight: 700; color: #059669 !important; font-size: 12pt;}
    @page { size: A4; margin: 10mm; }
  </style></head><body>${getPrintPreview(supplyId,emp,rows)}</body></html>`;
  
  const win=window.open('','_blank'); 
  win.document.write(printHtml); 
  win.document.close(); 
  
  // Wait a short moment for the content to render before printing
  setTimeout(() => win.print(), 300);
}

</script>
</body>
</html>